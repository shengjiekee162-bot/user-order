<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="utf-8">
<title>Admin 控制台</title>
<style>
body{font-family:Arial;background:#f7f7f7;padding:20px}
.container{max-width:1000px;margin:0 auto}
.card{background:#fff;padding:12px;border-radius:8px;box-shadow:0 2px 6px rgba(0,0,0,0.06);margin-bottom:12px}
.table{width:100%;border-collapse:collapse}
.table th,.table td{padding:8px;border:1px solid #eee}
.btn{padding:6px 10px;border-radius:6px;border:none;cursor:pointer}
.btn-danger{background:#f44336;color:#fff}
.btn-secondary{background:#ddd}
</style>
</head>
<body>
<div class="container">
  <h2>管理员面板</h2>
  <div id="info" style="margin-bottom:12px"></div>

  <div class="card">
    <h3>用户列表</h3>
    <table class="table" id="usersTable"><thead><tr><th>ID</th><th>用户名</th><th>角色</th><th>操作</th></tr></thead><tbody></tbody></table>
  </div>

  <div class="card">
    <h3>商品列表（最新50）</h3>
    <table class="table" id="productsTable"><thead><tr><th>ID</th><th>名称</th><th>价格</th><th>卖家</th><th>操作</th></tr></thead><tbody></tbody></table>
  </div>
</div>

<script>
const adminUser = JSON.parse(localStorage.getItem('user')||'null');
if(!adminUser || adminUser.role !== 'admin'){
  alert('需要管理员账户访问此页面');
  window.location.href = 'login.html';
}

document.getElementById('info').innerHTML = `已以管理员身份登录：<b>${adminUser.username}</b> <button onclick="logout()" style="margin-left:8px">退出</button>`;

async function safeFetch(url, options){
  try{ const r = await fetch(url, options); return await r.json(); }catch(e){ alert('网络错误:'+e.message); return null; }
}

async function loadUsers(){
  const users = await safeFetch('api.php?action=list_users');
  const tbody = document.querySelector('#usersTable tbody');
  tbody.innerHTML = '';
  users.forEach(u=>{
    tbody.innerHTML += `<tr><td>${u.id}</td><td>${u.username}</td><td id="role-${u.id}">${u.role}</td><td>
      <select id="sel-${u.id}"><option value="buyer">buyer</option><option value="seller">seller</option><option value="admin">admin</option></select>
      <button class="btn" onclick="setRole(${u.id})">设置</button>
    </td></tr>`;
    document.getElementById(`sel-${u.id}`).value = u.role;
  });
}

async function setRole(userId){
  const sel = document.getElementById(`sel-${userId}`);
  const role = sel.value;
  const res = await safeFetch('api.php', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({action:'set_user_role', admin_id: adminUser.id, user_id: userId, role})});
  if(res && res.status === 'ok'){ document.getElementById(`role-${userId}`).innerText = role; alert('更新成功'); }
  else alert('更新失败：' + (res && res.message));
}

async function loadProducts(){
  const products = await safeFetch('api.php');
  const tbody = document.querySelector('#productsTable tbody');
  tbody.innerHTML = '';
  (products||[]).slice(0,50).forEach(p=>{
    tbody.innerHTML += `<tr><td>${p.id}</td><td>${p.name}</td><td>RM ${parseFloat(p.price).toFixed(2)}</td><td>${p.seller_id}</td><td><button class="btn btn-danger" onclick="adminDelete(${p.id})">删除</button></td></tr>`;
  });
}

async function adminDelete(id){
  if(!confirm('确定要由管理员删除该商品吗？')) return;
  const res = await safeFetch('api.php', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({action:'admin_delete_product', id, admin_id: adminUser.id})});
  if(res && res.status === 'ok'){ alert('删除成功'); loadProducts(); } else alert('删除失败：' + (res && res.message));
}

function logout(){ localStorage.removeItem('user'); window.location.href='login.html'; }

// 初始化
loadUsers(); loadProducts();
</script>
</body>
</html>
