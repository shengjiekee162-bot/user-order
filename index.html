<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<title>ç¤ºä¾‹å•†åŸ ğŸ›ï¸</title>
  <!-- å“åº”å¼è§†çª— -->
  <meta name="viewport" content="width=device-width, initial-scale=1">
<style>
/* Tech-style theme: dark, neon accents, glass panels */
:root{
  /* Blue neon + purple cyberpunk */
  --bg:#040616; /* deep near-black */
  --panel:rgba(10,14,28,0.6);
  --muted:#9fb6d9;
  --accent:#00e6ff;    /* neon blue */
  --accent-2:#8a3bff;  /* cyber purple */
  --glass: rgba(255,255,255,0.03);
  --glow: 0 6px 30px rgba(138,59,255,0.12), 0 2px 8px rgba(0,230,255,0.06);
}
*{box-sizing:border-box}
html,body{height:100%;margin:0;font-family:Inter,ui-sans-serif,system-ui,-apple-system,'Segoe UI',Roboto,'Helvetica Neue',Arial;color:var(--muted);background:linear-gradient(180deg,#07101b 0%, #04101a 60%), var(--bg)}
main{flex:1;padding:24px}
header{background:linear-gradient(90deg, rgba(138,59,255,0.12), rgba(0,230,255,0.08));color:#e8f7ff;display:flex;align-items:center;justify-content:space-between;padding:14px 20px;border-radius:10px;box-shadow:var(--glow);margin-bottom:14px}
header h1{margin:0;color:#ffffff;font-weight:800;letter-spacing:0.6px;text-shadow:0 2px 18px rgba(0,230,255,0.08)}
header .user{color:#dffaff}
.search-bar{display:flex;gap:8px;margin-bottom:12px}
.search-bar input{flex:1;padding:10px 12px;border-radius:10px;border:1px solid rgba(255,255,255,0.06);background:linear-gradient(180deg,rgba(255,255,255,0.01),transparent);color:#e6eef8;box-shadow:inset 0 1px 0 rgba(255,255,255,0.02)}
.search-bar button{background:linear-gradient(90deg,var(--accent),var(--accent-2));border:none;color:#041226;padding:10px 14px;border-radius:10px;cursor:pointer;box-shadow:0 8px 28px rgba(0,230,255,0.10)}
.categories{display:flex;gap:8px;margin-bottom:12px;flex-wrap:wrap}
.categories button{background:linear-gradient(180deg,rgba(255,255,255,0.01),transparent);border:1px solid rgba(255,255,255,0.03);padding:8px 12px;border-radius:999px;color:var(--muted);cursor:pointer;transition:all .18s}
.categories button:hover{transform:translateY(-3px);box-shadow:0 10px 28px rgba(0,0,0,0.6);color:var(--accent)}
.products{display:flex;flex-wrap:wrap;gap:12px}
.card{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));width:170px;padding:12px;border-radius:12px;box-shadow:0 8px 30px rgba(2,6,23,0.6);text-align:center;transition:transform .18s,border-color .18s;border:1px solid rgba(255,255,255,0.03)}
.card:hover{transform:translateY(-6px);border-color:rgba(138,59,255,0.18);box-shadow:0 16px 40px rgba(138,59,255,0.08), 0 6px 24px rgba(0,230,255,0.06)}
.card h4{margin:8px 0 6px 0;color:#e8f7ff;font-size:14px;text-shadow:0 1px 8px rgba(138,59,255,0.04)}
.card p{color:var(--muted);margin:0 0 8px 0}
.card button{width:100%;padding:8px;border-radius:8px;border:none;background:linear-gradient(90deg,var(--accent),var(--accent-2));color:#061427;font-weight:700;cursor:pointer;box-shadow:0 6px 18px rgba(0,230,255,0.12), inset 0 -2px 8px rgba(138,59,255,0.06)}
.thumbnail-row{display:flex;gap:6px;margin-bottom:8px}
.thumbnail-row img,.thumbnail-row video{width:100%;height:100%;display:block;border-radius:8px;object-fit:cover}
.cart{margin-top:10px;padding:10px;background:linear-gradient(90deg,#0b1220, #071226);color:var(--accent);border-radius:10px;text-align:center;cursor:pointer}
.form-group{margin-bottom:10px}
.form-group input{width:100%;padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:#e6eef8}
.form-group button{width:100%;padding:8px;border-radius:8px;border:none;background:linear-gradient(90deg,var(--accent-2),var(--accent));color:#041421}
  .modal{position:fixed;inset:0;background:rgba(3,6,12,0.6);display:flex;align-items:center;justify-content:center;z-index:999}
  /* Make checkout / media panels opaque (no glass transparency) */
  .modal-content{background:linear-gradient(180deg,#071126,#041026);padding:18px;width:90%;max-width:980px;border-radius:12px;box-shadow:0 20px 60px rgba(2,6,23,0.9);border:1px solid rgba(138,59,255,0.12)}
/* responsive */
@media (max-width:900px){body{padding:0}main{padding:14px}.card{width:46%}}
@media (max-width:600px){.card{width:48%}.search-bar{flex-direction:column}}
</style>
</style>
</head>
<body>

<main>
<header>
  <h1 data-i18n="site.title">ç¤ºä¾‹å•†åŸ ğŸ›’</h1>
  <div style="display:flex; align-items:center; gap:8px;">

  <!-- user display area (rendered by showUser) -->
  <div id="userDisplay" class="user" style="color:white; font-size:14px; margin-left:8px;"></div>

  <div class="sidebar" style="display:none;">
  </div>
</header>



<div class="search-bar">
  <input type="text" id="searchInput" placeholder="æœç´¢å•†å“..." data-i18n="search.placeholder" data-i18n-attr="placeholder">
  <button id="searchBtn" onclick="searchProducts()" data-i18n="search.button">æœç´¢</button>
  <!-- æ‹ç…§æœç´¢æŒ‰é’®ï¼šéšè— file inputï¼Œä½¿ç”¨æŒ‰é’®è§¦å‘æ‹ç…§/ä¸Šä¼  -->
  <input type="file" id="imageInput" accept="image/*" capture="environment" style="display:none;" />
  <button onclick="document.getElementById('imageInput').click();" style="margin-left:8px; background:#fff; color:#f53d2d; border:1px solid #f53d2d; padding:6px 10px; border-radius:6px;" data-i18n="camera.button">ğŸ“· æ‹ç…§æœç´¢</button>
</div>

<div class="categories" id="categoriesBar">
  <!-- categories will be loaded dynamically -->
</div>

<div class="products" id="productContainer"></div>

  <div style="display:flex; gap:10px;">
  <div class="cart" onclick="toggleCheckoutForm()"><span data-i18n="cart.label">ğŸ›’ è´­ç‰©è½¦</span> (<span id="count">0</span>)</div>
  <div class="cart"><a href="orders.html" style="color:white; text-decoration:none; display:block;" data-i18n="orders.link">ğŸ“¦ æˆ‘çš„è®¢å•</a></div>
  </div>

<!-- ç»“è´¦æ¨¡æ€å¼¹çª—ï¼ˆåˆå¹¶åœ°å€/æ”¯ä»˜/ä¸ªäººèµ„æ–™ï¼‰ -->
<div id="checkoutModal" class="modal" style="display:none;">
  <div class="modal-content">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
    <h3 data-i18n="checkout.title">ç»“è´¦ & æ”¯ä»˜</h3>
      <div>
        <span style="margin-right:10px; color:#666">å½“å‰ç”¨æˆ·: <b id="checkoutUser">æœªç™»å½•</b></span>
        <button onclick="showCheckoutTab()" style="background:#fff; border:1px solid #ddd; padding:6px 8px; border-radius:4px; margin-right:6px;" data-i18n="checkout.title">ç»“è´¦</button>
        <button onclick="showOrdersTab()" style="background:#fff; border:1px solid #ddd; padding:6px 8px; border-radius:4px; margin-right:6px;">æˆ‘çš„è®¢å•</button>
        <button onclick="toggleCheckoutForm()" style="background:#ddd; border:none; padding:6px 8px; border-radius:4px;">å…³é—­</button>
      </div>
    </div>

    <!-- è®¢å•æ‘˜è¦ï¼ˆæ˜¾ç¤ºè´­ç‰©è½¦é‡Œçš„å•†å“ï¼‰ -->
    <div id="orderSummary" style="margin-bottom:12px; display:none;">
      <h4>è®¢å•æ‘˜è¦</h4>
      <div id="orderSummaryBody" style="background:#fbfbfb; padding:10px; border-radius:6px;">
        <!-- JS å¡«å……è´­ç‰©è½¦å•†å“ -->
      </div>
    </div>

    <div style="display:flex; gap:20px;">
      <!-- å·¦ä¾§ï¼šåœ°å€é€‰æ‹©/æ·»åŠ  -->
      <div style="flex:1;">
        <h4>æ”¶ä»¶åœ°å€</h4>
        <div id="addressSelectArea" class="form-group">
          <select id="addressSelect" style="width:100%; padding:6px; border:1px solid #ddd; border-radius:4px;">
            <option value="">è¯·é€‰æ‹©æ”¶è´§åœ°å€</option>
          </select>
          <button onclick="showAddAddressForm()" style="margin-top:8px; width:100%; background:#4CAF50; color:white; border:none; border-radius:4px; padding:6px;">æ·»åŠ æ–°åœ°å€</button>
        </div>
        <div id="addAddressForm" style="display:none; margin-bottom:10px;">
          <input type="hidden" id="editingAddressId" value="">
          <input type="text" id="newRecipientName" placeholder="æ”¶ä»¶äººå§“å" style="margin-bottom:5px; width:100%; padding:6px; border:1px solid #ddd; border-radius:4px;">
          <input type="text" id="newRecipientAddress" placeholder="æ”¶è´§åœ°å€" style="margin-bottom:5px; width:100%; padding:6px; border:1px solid #ddd; border-radius:4px;">
          <input type="text" id="newRecipientPhone" placeholder="è”ç³»ç”µè¯ (å¯é€‰)" style="margin-bottom:5px; width:100%; padding:6px; border:1px solid #ddd; border-radius:4px;">
          <textarea id="newRecipientNote" placeholder="å¤‡æ³¨ï¼ˆå¯é€‰ï¼‰" style="margin-bottom:5px; width:100%; padding:6px; border:1px solid #ddd; border-radius:4px; min-height:56px"></textarea>
          <label style="display:block; margin-bottom:5px;"><input type="checkbox" id="isDefaultAddress"> è®¾ä¸ºé»˜è®¤åœ°å€</label>
          <button id="saveAddressBtn" onclick="saveAddress()" style="width:100%; background:#f53d2d; color:white; border:none; border-radius:4px; padding:6px;">ä¿å­˜åœ°å€</button>
          <button onclick="hideAddAddressForm()" style="width:100%; background:#ddd; color:#333; border:none; border-radius:4px; padding:6px; margin-top:5px;">å–æ¶ˆ</button>
        </div>
        <div id="addressListArea" style="margin-top:8px"></div>
      </div>

      <!-- å³ä¾§ï¼šæ”¯ä»˜æ–¹å¼ -->
      <div style="width:320px;">
        <h4>æ”¯ä»˜æ–¹å¼</h4>
        <div class="payment-methods">
          <div class="payment-option" onclick="selectPayment('cash')">
            <input type="radio" name="payment" value="cash" id="pay_cash" checked>
            <label for="pay_cash">
              <span class="icon">ğŸ’µ</span>
              <span class="text">ç°é‡‘æ”¯ä»˜</span>
              <span class="desc">è´§åˆ°ä»˜æ¬¾</span>
            </label>
          </div>
          <div class="payment-option" onclick="selectPayment('credit_card')">
            <input type="radio" name="payment" value="credit_card" id="pay_card">
            <label for="pay_card">
              <span class="icon">ğŸ’³</span>
              <span class="text">ä¿¡ç”¨å¡</span>
              <span class="desc">æ”¯æŒ Visa / Mastercard</span>
            </label>
          </div>
          <div class="payment-option" onclick="selectPayment('online_banking')">
            <input type="radio" name="payment" value="online_banking" id="pay_bank">
            <label for="pay_bank">
              <span class="icon">ğŸ¦</span>
              <span class="text">ç½‘ä¸Šé“¶è¡Œ</span>
              <span class="desc">æ”¯æŒæ‰€æœ‰å¤§é©¬é“¶è¡Œ</span>
            </label>
          </div>
        </div>
        <div id="payment_details" style="display:none;">
          <!-- ä¿¡ç”¨å¡è¡¨å• -->
          <div id="card_form" class="payment-detail-form">
            <div class="form-group">
              <input type="text" placeholder="å¡å·" maxlength="19" oninput="formatCardNumber(this)">
            </div>
            <div style="display:flex;gap:10px;">
              <div class="form-group">
                <input type="text" placeholder="æœ‰æ•ˆæœŸ MM/YY" maxlength="5">
              </div>
              <div class="form-group">
                <input type="text" placeholder="CVV" maxlength="3">
              </div>
            </div>
          </div>
          <!-- ç½‘é“¶è¡¨å• -->
          <div id="bank_form" class="payment-detail-form">
            <div class="form-group">
              <select id="bankSelect" style="width:100%; padding:6px;">
                <option value="">é€‰æ‹©é“¶è¡Œ</option>
                <option value="maybank">Maybank</option>
                <option value="cimb">CIMB Bank</option>
                <option value="public">Public Bank</option>
                <option value="rhb">RHB Bank</option>
              </select>
            </div>
          </div>
        </div>

        <div class="form-group" style="margin-top:12px;">
          <button onclick="checkout()" style="margin-top:5px; width:100%;" data-i18n="checkout.place_order">ç¡®è®¤ä¸‹å•</button>
        </div>
      </div>
    </div>
  </div>
</div>

    <!-- è®¢å•åŒºåŸŸï¼ˆåŒ modal å†…ï¼‰ -->
    <div id="ordersSection" style="display:none; margin-top:12px;">
      <h3>æˆ‘çš„è®¢å•è®°å½•</h3>
      <div id="ordersListModal"></div>
    </div>

</main>

  <div class="sidebar" style="display:none;">
  <h4>å–å®¶åŠŸèƒ½</h4>
  <p style="color:#666; text-align:center;">è¯·è®¿é—® <a href="seller.html" style="color:#f53d2d; font-weight:bold;">å–å®¶ä¸­å¿ƒ</a> ç®¡ç†æ‚¨çš„å•†å“</p>
</div><script>
let cart = [];
let currentUser = JSON.parse(localStorage.getItem("user")) || null;
let currentCategory = '';
let currentKeyword = '';
let addressList = [];
let selectedAddressId = '';

// åœ°å€ç®¡ç†ç›¸å…³
async function loadAddresses() {
  if (!currentUser) return;
  const res = await safeFetch(`api.php?action=list_addresses&user_id=${currentUser.id}`);
  addressList = Array.isArray(res) ? res : [];
  const select = document.getElementById('addressSelect');
  select.innerHTML = '<option value="">è¯·é€‰æ‹©æ”¶è´§åœ°å€</option>';
  addressList.forEach(addr => {
    const phonePart = addr.phone ? (' Â· ' + addr.phone) : '';
    select.innerHTML += `<option value="${addr.id}"${addr.is_default ? ' selected' : ''}>${addr.recipient_name} - ${addr.recipient_address}${phonePart}${addr.is_default ? 'ï¼ˆé»˜è®¤ï¼‰' : ''}</option>`;
    if (addr.is_default) selectedAddressId = addr.id;
  });

  // Also render a compact address list with edit / delete buttons
  const listArea = document.getElementById('addressListArea');
  if(listArea){
    if(addressList.length === 0){
      listArea.innerHTML = '<div class="muted">æš‚æ— æ”¶ä»¶åœ°å€</div>';
    } else {
      listArea.innerHTML = addressList.map(a=>{
        return `<div style="padding:8px;border-radius:6px;margin-bottom:6px;background:rgba(255,255,255,0.02);display:flex;justify-content:space-between;gap:8px;align-items:center">`+
          `<div style="flex:1">`+
            `<div style="font-weight:700;color:#eaf6ff">${escapeHtml(a.recipient_name)} ${a.is_default ? '<span style="color:#8a3bff;font-weight:600">ï¼ˆé»˜è®¤ï¼‰</span>' : ''}</div>`+
            `<div style="color:var(--muted);font-size:0.95em">${escapeHtml(a.recipient_address)}</div>`+
            `${a.phone ? `<div style="color:var(--muted);font-size:0.95em">ç”µè¯: ${escapeHtml(a.phone)}</div>` : ''}`+
            `${a.note ? `<div style="color:var(--muted);font-size:0.9em;margin-top:6px">å¤‡æ³¨: ${escapeHtml(a.note)}</div>` : ''}`+
          `</div>`+
          `<div style="display:flex;gap:6px">`+
            `<button onclick="showEditAddress(${a.id})" style="background:#00d4ff;color:#031026;border:none;padding:6px 8px;border-radius:6px;cursor:pointer">ç¼–è¾‘</button>`+
            `<button onclick="deleteAddress(${a.id})" style="background:#f44336;color:#fff;border:none;padding:6px 8px;border-radius:6px;cursor:pointer">åˆ é™¤</button>`+
          `</div>`+
        `</div>`;
      }).join('');
    }
  }
}

function showAddAddressForm() {
  document.getElementById('addAddressForm').style.display = 'block';
}
function hideAddAddressForm() {
  document.getElementById('addAddressForm').style.display = 'none';
}

async function addAddress() {
  const name = document.getElementById('newRecipientName').value.trim();
  const address = document.getElementById('newRecipientAddress').value.trim();
  const isDefault = document.getElementById('isDefaultAddress').checked ? 1 : 0;
  if (!name || !address) return alert('è¯·å¡«å†™å®Œæ•´åœ°å€ä¿¡æ¯');
  const res = await safeFetch('api.php', {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify({
      action: 'add_address',
      user_id: currentUser.id,
      recipient_name: name,
      recipient_address: address,
      is_default: isDefault
    })
  });
  if (res && res.status === 'ok') {
    alert('åœ°å€å·²ä¿å­˜');
    hideAddAddressForm();
    document.getElementById('newRecipientName').value = '';
    document.getElementById('newRecipientAddress').value = '';
    document.getElementById('isDefaultAddress').checked = false;
    await loadAddresses();
  } else {
    alert(res && res.message ? res.message : 'ä¿å­˜å¤±è´¥');
  }
}

// Unified save function: add new or update existing
async function saveAddress(){
  const editingId = document.getElementById('editingAddressId').value;
  const name = document.getElementById('newRecipientName').value.trim();
  const address = document.getElementById('newRecipientAddress').value.trim();
  const isDefault = document.getElementById('isDefaultAddress').checked ? 1 : 0;
  if(!name || !address) return alert('è¯·å¡«å†™å®Œæ•´åœ°å€ä¿¡æ¯');

  const payload = {
    user_id: currentUser.id,
    recipient_name: name,
    recipient_address: address,
    phone: document.getElementById('newRecipientPhone').value.trim(),
    note: document.getElementById('newRecipientNote').value.trim(),
    is_default: isDefault
  };

  if(editingId){
    payload.action = 'update_address';
    payload.id = parseInt(editingId);
  } else {
    payload.action = 'add_address';
  }

  const res = await safeFetch('api.php', {
    method: 'POST',
    headers:{'Content-Type':'application/json'},
    body: JSON.stringify(payload)
  });

  if(res && res.status === 'ok'){
    alert('åœ°å€å·²ä¿å­˜');
    hideAddAddressForm();
    document.getElementById('newRecipientName').value = '';
    document.getElementById('newRecipientAddress').value = '';
    document.getElementById('isDefaultAddress').checked = false;
    document.getElementById('editingAddressId').value = '';
    await loadAddresses();
  } else {
    alert(res && res.message ? res.message : 'ä¿å­˜å¤±è´¥');
  }
}

// Show edit form for an existing address
function showEditAddress(id){
  const a = addressList.find(x=> Number(x.id) === Number(id));
  if(!a) return alert('åœ°å€æœªæ‰¾åˆ°');
  document.getElementById('editingAddressId').value = a.id;
  document.getElementById('newRecipientName').value = a.recipient_name;
  document.getElementById('newRecipientAddress').value = a.recipient_address;
  document.getElementById('isDefaultAddress').checked = !!a.is_default;
  document.getElementById('newRecipientPhone').value = a.phone || '';
  document.getElementById('newRecipientNote').value = a.note || '';
  document.getElementById('addAddressForm').style.display = 'block';
  // scroll into view inside modal if needed
  try{ document.getElementById('addAddressForm').scrollIntoView({behavior:'smooth', block:'center'}); }catch(e){}
}

// Delete an address
async function deleteAddress(id){
  if(!confirm('ç¡®å®šåˆ é™¤æ­¤åœ°å€ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚')) return;
  const res = await safeFetch('api.php', {
    method: 'POST',
    headers: {'Content-Type':'application/json'},
    body: JSON.stringify({ action: 'delete_address', user_id: currentUser.id, id: id })
  });
  if(res && res.status === 'ok'){
    alert('åœ°å€å·²åˆ é™¤');
    await loadAddresses();
  } else {
    alert(res && res.message ? res.message : 'åˆ é™¤å¤±è´¥');
  }
}

document.getElementById('addressSelect').addEventListener('change', function() {
  selectedAddressId = this.value;
});

function showUser() {
  const userDiv = document.getElementById('userDisplay');
  if(currentUser){
    let html = `
      æ¬¢è¿å›æ¥ <b>${currentUser.username}</b> 
      <span style="margin:0 10px">(${currentUser.role === 'buyer' ? 'ä¹°å®¶' : 'å–å®¶'})</span>
    `;
    if(currentUser.role === 'seller') {
      html += `<button onclick="window.location.href='seller.html'" style="background:#fff; color:#f53d2d; border:none; padding:3px 8px; border-radius:4px; cursor:pointer; margin-right:5px;">
        å–å®¶ä¸­å¿ƒ
      </button>`;
    }
    html += `<button onclick="switchRole()" style="background:#fff; color:#f53d2d; border:none; padding:3px 8px; border-radius:4px; cursor:pointer">
      åˆ‡æ¢ä¸º${currentUser.role === 'buyer' ? 'å–å®¶' : 'ä¹°å®¶'}
    </button>`;
    html += `<button onclick="logout()" style="background:#fff; color:#f53d2d; border:none; padding:3px 8px; border-radius:4px; cursor:pointer; margin-left:6px;">é€€å‡ºç™»å½•</button>`;
    userDiv.innerHTML = html;
  } else {
    userDiv.innerHTML = `<a href="login.html" style="color:white;">ç™»å½• / æ³¨å†Œ</a> Â· <a href="forgot_password.html" style="color:white;">å¿˜è®°å¯†ç </a>`;
  }
}

// é€€å‡ºç™»å½•ï¼šæ¸…é™¤ localStorage å¹¶è·³è½¬åˆ°ç™»å½•é¡µ
function logout(){
  localStorage.removeItem('user');
  window.location.href = 'login.html';
}

async function safeFetch(url, options){
  try{
    const res = await fetch(url, options);
    const text = await res.text();
    try { return JSON.parse(text);} catch { alert("è¿”å›éJSON"); return null;}
  } catch(err){ alert("ç½‘ç»œè¯·æ±‚å¤±è´¥:"+err.message); return null;}
}

// åŠ è½½å–å®¶çš„å•†å“åˆ—è¡¨
async function loadMyProducts() {
  // æ­¤åŠŸèƒ½å·²ç§»è‡³ seller.html
}

// å¼€å§‹ç¼–è¾‘å•†å“
async function editProduct(productId) {
  // æ­¤åŠŸèƒ½å·²ç§»è‡³ seller.html
}

// å–æ¶ˆç¼–è¾‘
function cancelEdit() {
  // æ­¤åŠŸèƒ½å·²ç§»è‡³ seller.html
}

// æ·»åŠ æˆ–æ›´æ–°å•†å“
async function addProduct(){
  // æ­¤åŠŸèƒ½å·²ç§»è‡³ seller.html
}

async function loadProducts(){
  const data = await safeFetch(`api.php?category=${encodeURIComponent(currentCategory)}&search=${encodeURIComponent(currentKeyword)}`);
  if(!data) return;
  const container = document.getElementById('productContainer');
  container.innerHTML = '';
  // Deduplicate products by name (case-insensitive) to avoid showing duplicates
  const seen = new Set();
  const unique = [];
  data.forEach(p => {
    const nameKey = (p && p.name) ? String(p.name).trim().toLowerCase() : '';
    if(!seen.has(nameKey)){
      seen.add(nameKey);
      unique.push(p);
    }
  });
  unique.forEach(p=>{
    const mediaHtml = renderMediaHTML(p);
    container.innerHTML += `
      <div class="card">
        ${mediaHtml}
        <h4>${escapeHtml(p.name)}</h4>
        <p>RM ${escapeHtml(String(p.price || '0'))}</p>
        <button onclick='addToCart(${JSON.stringify(p)})'>åŠ å…¥è´­ç‰©è½¦</button>
      </div>
    `;
  });
}

// return a thumbnail URL (or direct image URL) for product media; handles JSON arrays and YouTube links
// Render media HTML for a product card: prefers first media (image, video, or YouTube)
function renderMediaHTML(p){
  try{
    let imgs = p.image;
    if(!imgs) return '';
    if(typeof imgs === 'string' && imgs.trim().startsWith('[')) imgs = JSON.parse(imgs);
    if(!Array.isArray(imgs)) imgs = [imgs];
    if(imgs.length === 0) return '';
    // Render up to 3 media thumbnails (image, video or YouTube thumbnail)
    const maxThumbs = 3;
    const parts = imgs.map(i => String(i).replace(/\r?\n/g, '').trim()).filter(Boolean);
    if(parts.length === 0) return '';

    // helper to detect youtube id
    const extractYt = s => {
      const m = s.match(/(?:youtube\.com\/(?:watch\?v=|embed\/)|youtu\.be\/)([A-Za-z0-9_-]{6,})/);
      return (m && m[1]) ? m[1] : null;
    };

    // build HTML grid for up to maxThumbs
    const used = parts.slice(0, maxThumbs);
    const cols = used.length;
    const cellWidth = Math.floor(100 / cols);
    let html = `<div style="display:flex;gap:6px;margin-bottom:8px;border-radius:8px;overflow:hidden">`;
    used.forEach((item, ti) => {
      const thumbIndex = ti;
      const yt = extractYt(item);
      const lower = item.toLowerCase();
      if (yt) {
        // show YouTube thumbnail (lighter than iframe)
        const thumb = `https://img.youtube.com/vi/${yt}/hqdefault.jpg`;
        html += `<div onclick='openMediaModal(${JSON.stringify(p)}, ${thumbIndex})' style="flex:1 1 ${cellWidth}% ;height:120px;overflow:hidden;border-radius:6px;cursor:pointer"><img src="${escapeHtml(thumb)}" style="width:100%;height:100%;object-fit:cover;display:block"></div>`;
      } else if (lower.match(/\.(jpg|jpeg|png|gif|webp)$/i) || item.startsWith('http') || item.indexOf('uploads/') === 0) {
        html += `<div onclick='openMediaModal(${JSON.stringify(p)}, ${thumbIndex})' style="flex:1 1 ${cellWidth}% ;height:120px;overflow:hidden;border-radius:6px;cursor:pointer"><img src="${escapeHtml(item)}" alt="${escapeHtml(p.name)}" style="width:100%;height:100%;object-fit:cover;display:block"></div>`;
      } else if (lower.match(/\.(mp4|webm|ogg|mov)$/i)) {
        html += `<div onclick='openMediaModal(${JSON.stringify(p)}, ${thumbIndex})' style="flex:1 1 ${cellWidth}% ;height:120px;overflow:hidden;border-radius:6px;cursor:pointer"><video src="${escapeHtml(item)}" style="width:100%;height:100%;object-fit:cover;display:block" muted playsinline></video></div>`;
      } else {
        // unknown type - render as text fallback
        html += `<div onclick='openMediaModal(${JSON.stringify(p)}, ${thumbIndex})' style="flex:1 1 ${cellWidth}% ;height:120px;overflow:hidden;border-radius:6px;background:#f0f0f0;display:flex;align-items:center;justify-content:center;color:#888;cursor:pointer">${escapeHtml(item)}</div>`;
      }
    });
    html += `</div>`;
    return html;
  }catch(e){ return ''; }
}

// æ‹ç…§æœç´¢ï¼šä¸Šä¼ å›¾ç‰‡åˆ°åç«¯å¹¶æ˜¾ç¤ºæœç´¢ç»“æœ
document.getElementById('imageInput').addEventListener('change', async function(e){
  const file = e.target.files[0];
  if(!file) return;
  const imgPreview = document.createElement('div');
  imgPreview.style.margin = '10px 0';
  imgPreview.innerHTML = `<div style="margin-bottom:6px">æ­£åœ¨ä¸Šä¼ å›¾ç‰‡å¹¶æœç´¢ç›¸ä¼¼å•†å“...</div>`;
  const container = document.getElementById('productContainer');
  container.prepend(imgPreview);

  const fd = new FormData();
  fd.append('image', file);

  try{
    const res = await fetch('image_search.php', { method: 'POST', body: fd });
    const data = await res.json();
    imgPreview.remove();
    if(!data) return alert('æœç´¢å¤±è´¥');
    if(data.message) {
      // æœåŠ¡ç«¯å¯èƒ½è¿”å›ä¿¡æ¯
      console.info('image_search:', data.message);
    }
    // data.products æœŸæœ›ä¸ºæ•°ç»„
    const products = Array.isArray(data.products) ? data.products : [];
    if(products.length === 0){
      container.innerHTML = '<p style="color:#999">æœªæ‰¾åˆ°ç›¸ä¼¼å•†å“ï¼Œæ˜¾ç¤ºå…¨éƒ¨å•†å“ä½œä¸ºå›é€€ã€‚</p>';
      await loadProducts();
      return;
    }
    // æ¸²æŸ“ç»“æœ
    container.innerHTML = '';
    products.forEach(p=>{
      container.innerHTML += `
      <div class="card">
        <h4>${escapeHtml(p.name)}</h4>
        <p>RM ${p.price}</p>
        <button onclick='addToCart(${JSON.stringify(p)})'>åŠ å…¥è´­ç‰©è½¦</button>
      </div>
    `;
    });
  } catch(err){
    imgPreview.remove();
    alert('ä¸Šä¼ æˆ–æœç´¢å¤±è´¥: ' + err.message);
  } finally{
    // æ¸…ç©º input ä»¥ä¾¿åç»­å¯é‡å¤é€‰æ‹©åŒä¸€æ–‡ä»¶
    e.target.value = '';
  }
});

function addToCart(p){
  // normalize id and price to numbers to avoid type mismatch
  const pid = Number(p.id);
  const price = parseFloat(p.price) || 0;
  const found = cart.find(i=> Number(i.id) === pid );
  if(found) found.quantity = (parseInt(found.quantity)||0) + 1;
  else cart.push({ ...p, id: pid, price: price, quantity: 1 });
  updateCartUI();
}

// æ¸²æŸ“è®¢å•æ‘˜è¦ï¼ˆåœ¨ç»“è´¦æ—¶æ˜¾ç¤ºè´­ç‰©è½¦å†…å®¹ï¼‰
function renderOrderSummary(){
  const container = document.getElementById('orderSummaryBody');
  if(!container) return;
  if(!cart || cart.length===0){
    container.innerHTML = '<p>è´­ç‰©è½¦ä¸ºç©º</p>';
    document.getElementById('orderSummary').style.display = 'none';
    updateCartCount();
    return;
  }
  document.getElementById('orderSummary').style.display = 'block';
  let total = 0;
  let html = '<table><thead><tr><th>å•†å“</th><th>å•ä»·</th><th style="width:180px">æ•°é‡</th><th>å°è®¡</th><th>æ“ä½œ</th></tr></thead><tbody>';
  cart.forEach(it=>{
    const subtotal = parseFloat(it.price) * parseInt(it.quantity);
    total += subtotal;
    html += `<tr id="cart-row-${it.id}"><td>${escapeHtml(it.name)}</td><td>RM ${parseFloat(it.price).toFixed(2)}</td><td style="text-align:center">`+
      `<button class="cart-decrease" data-product-id="${it.id}" style="padding:4px 8px">-</button>`+
      ` <input class="cart-qty" data-product-id="${it.id}" type="number" min="1" value="${it.quantity}" style="width:56px;text-align:center;margin:0 6px">`+
      `<button class="cart-increase" data-product-id="${it.id}" style="padding:4px 8px">+</button>`+
    `</td><td>RM ${subtotal.toFixed(2)}</td><td><button class="cart-remove" data-product-id="${it.id}" style="background:#f44336;color:#fff;border:none;padding:6px 8px;border-radius:4px;cursor:pointer">åˆ é™¤</button></td></tr>`;
  });
  html += `</tbody></table><div class="total">æ€»è®¡: RM ${total.toFixed(2)}</div>`;
  container.innerHTML = html;
  updateCartCount();
  // Attach event listeners (use delegation-like binding)
  container.querySelectorAll('.cart-decrease').forEach(b=> b.addEventListener('click', e=>{
    const id = parseInt(b.getAttribute('data-product-id'));
    changeQuantity(id, -1);
  }));
  container.querySelectorAll('.cart-increase').forEach(b=> b.addEventListener('click', e=>{
    const id = parseInt(b.getAttribute('data-product-id'));
    changeQuantity(id, 1);
  }));
  container.querySelectorAll('.cart-qty').forEach(inp=> inp.addEventListener('change', e=>{
    const id = parseInt(inp.getAttribute('data-product-id'));
    setQuantity(id, inp.value);
  }));
  container.querySelectorAll('.cart-remove').forEach(b=> b.addEventListener('click', e=>{
    const id = parseInt(b.getAttribute('data-product-id'));
    removeFromCart(id);
  }));
}

function changeQuantity(productId, delta){
  const item = cart.find(c=> Number(c.id) === Number(productId));
  if(!item) return;
  item.quantity = Math.max(1, (parseInt(item.quantity) || 0) + delta);
  updateCartUI();
}

function setQuantity(productId, val){
  let q = parseInt(val);
  if(isNaN(q) || q < 1) q = 1;
  const item = cart.find(c=> Number(c.id) === Number(productId));
  if(!item) return;
  item.quantity = q;
  updateCartUI();
}

function removeFromCart(productId){
  cart = cart.filter(c=> Number(c.id) !== Number(productId));
  updateCartUI();
}

function updateCartUI(){
  // update count display and order summary
  updateCartCount();
  renderOrderSummary();
  // debug: log cart state and total
  try{
    const total = cart.reduce((s,i)=>s + (parseFloat(i.price)||0) * (parseInt(i.quantity)||0), 0);
    console.log('Cart debug', cart, 'total=', total);
  } catch(e){ console.log('Cart debug error', e); }
}

function updateCartCount(){
  const countEl = document.getElementById('count');
  if(countEl) countEl.innerText = cart.reduce((a,b)=>a+b.quantity,0);
}

// ç®€å•è½¬ä¹‰æ–‡æœ¬ï¼Œé˜²æ­¢ XSSï¼ˆè´­ç‰©è½¦æ•°æ®æ¥è‡ªæœ¬ç«™ï¼‰
function escapeHtml(str){
  if(!str) return '';
  return String(str).replace(/[&<>"']/g, function(s){
    return {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[s];
  });
}

async function toggleCheckoutForm(){
  const modal = document.getElementById('checkoutModal');
  const ordersDiv = document.getElementById('myOrders');
  if(modal.style.display === 'none' || modal.style.display === ''){
    // æ‰“å¼€æ¨¡æ€ï¼šåŠ è½½åœ°å€å¹¶åˆå§‹åŒ–è§†å›¾
    if(!currentUser) return alert('è¯·å…ˆç™»å½•');
    document.getElementById('checkoutUser').innerText = currentUser.username || 'æœªçŸ¥ç”¨æˆ·';
    await loadAddresses();
    // è®¾ç½®ä¸‹æ‹‰ä¸ºé»˜è®¤åœ°å€ï¼ˆå¦‚æœæœ‰ï¼‰
    const select = document.getElementById('addressSelect');
    try{ select.value = selectedAddressId || ''; }catch(e){}
  // é»˜è®¤æ”¯ä»˜æ–¹å¼ä¸ºç°é‡‘
  selectPayment('cash');
  // ç¡®ä¿æ˜¾ç¤ºç»“è´¦ï¼ˆéè®¢å•ï¼‰é¡µç­¾
  showCheckoutTab();
  // æ¸²æŸ“è®¢å•æ‘˜è¦
  renderOrderSummary();
    // éšè—è®¢å•åˆ—è¡¨
    if(ordersDiv) ordersDiv.style.display = 'none';
    modal.style.display = 'flex';
  } else {
    modal.style.display = 'none';
  }
}

async function openOrdersModal(){
  if(!currentUser) return alert('è¯·å…ˆç™»å½•');
  const modal = document.getElementById('checkoutModal');
  document.getElementById('checkoutUser').innerText = currentUser.username || 'æœªçŸ¥ç”¨æˆ·';
  // æ˜¾ç¤º modal å¹¶åˆ‡æ¢åˆ°è®¢å•åŒºåŸŸ
  await loadAddresses();
  // show orders section
  showOrdersTab();
  modal.style.display = 'flex';
}

async function showOrdersTab(){
  const checkoutSection = document.querySelector('.modal-content > div:nth-child(2)');
  // éšè—å·¦/right checkout layout
  // ç›´æ¥å±•ç¤ºè®¢å•åˆ—è¡¨åŒºåŸŸ
  document.getElementById('ordersSection').style.display = 'block';
  document.getElementById('addressSelectArea').style.display = 'none';
  document.getElementById('payment_details').style.display = 'none';
  // åŠ è½½è®¢å•
  const orders = await safeFetch(`api.php?action=my_orders&user_id=${currentUser.id}`);
  if(!orders) return;
  const list = document.getElementById('ordersListModal');
  list.innerHTML = orders.length ? orders.map(order => `
    <div class="order-card">
      <h4>è®¢å•å·: #${order.id}</h4>
      <div class="items">${order.items}</div>
      <div class="meta">
        <div>æ”¶ä»¶äºº: ${order.recipient_name}</div>
        <div>åœ°å€: ${order.recipient_address}</div>
        <div>æ€»ä»·: RM ${order.total_price}</div>
        <div>æ”¯ä»˜æ–¹å¼: ${getPaymentMethodText(order.payment_method)}</div>
        <div>æ”¯ä»˜çŠ¶æ€: ${getPaymentStatusText(order.payment_status)}</div>
        <div>ä¸‹å•æ—¶é—´: ${new Date(order.created_at).toLocaleString()}</div>
      </div>
    </div>
  `).join('') : '<p>æš‚æ— è®¢å•è®°å½•</p>';
}

function showCheckoutTab(){
  // æ¢å¤åœ°å€/æ”¯ä»˜ç•Œé¢
  document.getElementById('ordersSection').style.display = 'none';
  document.getElementById('addressSelectArea').style.display = 'block';
  selectPayment('cash');
  // æ›´æ–°è®¢å•æ‘˜è¦å†…å®¹
  renderOrderSummary();
}

// æ ¼å¼åŒ–ä¿¡ç”¨å¡å·
function formatCardNumber(input) {
  let value = input.value.replace(/\D/g, '');
  let formattedValue = '';
  for(let i = 0; i < value.length; i++) {
    if(i > 0 && i % 4 === 0) {
      formattedValue += ' ';
    }
    formattedValue += value[i];
  }
  input.value = formattedValue;
}

// é€‰æ‹©æ”¯ä»˜æ–¹å¼
function selectPayment(method) {
  // æ›´æ–°å•é€‰æ¡†
  document.querySelectorAll('.payment-option').forEach(opt => {
    opt.classList.remove('selected');
    if(opt.querySelector(`#pay_${method}`)) {
      opt.classList.add('selected');
      opt.querySelector(`#pay_${method}`).checked = true;
    }
  });

  // æ˜¾ç¤º/éšè—å¯¹åº”çš„æ”¯ä»˜è¯¦æƒ…è¡¨å•
  const detailsDiv = document.getElementById('payment_details');
  const cardForm = document.getElementById('card_form');
  const bankForm = document.getElementById('bank_form');

  if(method === 'credit_card') {
    detailsDiv.style.display = 'block';
    cardForm.style.display = 'block';
    bankForm.style.display = 'none';
  } else if(method === 'online_banking') {
    detailsDiv.style.display = 'block';
    cardForm.style.display = 'none';
    bankForm.style.display = 'block';
  } else {
    detailsDiv.style.display = 'none';
  }
}

async function checkout(){
  if(!currentUser || currentUser.role!=="buyer") return alert("è¯·ä½¿ç”¨ä¹°å®¶è´¦å·ç™»å½•ï¼");
  if(cart.length===0) return alert("è´­ç‰©è½¦ä¸ºç©ºï¼");
  // è·å–é€‰ä¸­çš„åœ°å€
  const addr = addressList.find(a => a.id == selectedAddressId);
  if (!addr) return alert('è¯·é€‰æ‹©æ”¶è´§åœ°å€');
  const recipient_name = addr.recipient_name;
  const recipient_address = addr.recipient_address;

  // è·å–é€‰ä¸­çš„æ”¯ä»˜æ–¹å¼
  const payment_method = document.querySelector('input[name="payment"]:checked').value;
  
  // éªŒè¯æ”¯ä»˜ä¿¡æ¯
  if(payment_method === 'credit_card') {
    const cardInputs = document.querySelectorAll('#card_form input');
    for(let input of cardInputs) {
      if(!input.value.trim()) return alert("è¯·å¡«å†™å®Œæ•´çš„ä¿¡ç”¨å¡ä¿¡æ¯");
    }
  } else if(payment_method === 'online_banking') {
    const bankSelect = document.querySelector('#bank_form select');
    if(!bankSelect.value) return alert("è¯·é€‰æ‹©é“¶è¡Œ");
  }

  const itemsToSend = cart.map(p=>({id:p.id,price:p.price,quantity:p.quantity}));
  const msg = await safeFetch("api.php",{
    method:"POST",
    headers:{'Content-Type':'application/json'},
    body:JSON.stringify({
      action:"create_order",
      user_id:currentUser.id,
      items:itemsToSend,
      recipient_name,
      recipient_address,
      payment_method
    })
  });
  if(!msg) return;
  if(msg.status==="ok"){
    alert("è®¢å•åˆ›å»ºæˆåŠŸï¼");
    cart=[];
    document.getElementById('count').innerText=0;
    toggleCheckoutForm();
    loadProducts();
  } else alert("ä¸‹å•å¤±è´¥ï¼š"+msg.message);
}

async function addProduct(){
  if(!currentUser || currentUser.role!=="seller") return alert("è¯·ä½¿ç”¨å–å®¶è´¦å·ç™»å½•ï¼");
  const name = document.getElementById('productName').value.trim();
  const price = parseFloat(document.getElementById('productPrice').value);
  const category_id = parseInt(document.getElementById('productCategory').value);
  const description = document.getElementById('productDesc').value.trim();
  if(!name||!price||!category_id) return alert("è¯·å¡«å†™å®Œæ•´ä¿¡æ¯");

  const msg = await safeFetch("api.php",{
    method:"POST",
    headers:{'Content-Type':'application/json'},
    body:JSON.stringify({action:"add_product",name,price,category_id,seller_id:currentUser.id,description})
  });
  if(!msg) return;
  alert(msg.message);
  if(msg.status==="ok"){
    document.getElementById('productName').value='';
    document.getElementById('productPrice').value='';
    document.getElementById('productCategory').value='';
    document.getElementById('productDesc').value='';
    loadProducts();
  }
}

function searchProducts(){
  currentKeyword=document.getElementById('searchInput').value;
  loadProducts();
}

function filterCategory(cat){
  currentCategory=cat;
  loadProducts();
}

// åˆ‡æ¢è§’è‰²å‡½æ•°
async function switchRole() {
  if (!currentUser) return;
  
  const newRole = currentUser.role === 'buyer' ? 'seller' : 'buyer';
  const msg = await safeFetch("auth.php", {
    method: "POST",
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify({
      action: "switch_role",
      user_id: currentUser.id,
      role: newRole
    })
  });

  if (msg && msg.status === "ok") {
    currentUser = msg.user;
    localStorage.setItem("user", JSON.stringify(currentUser));
    showUser();
    // åˆ·æ–°é¡µé¢æ˜¾ç¤º
    document.querySelector('.sidebar').style.display = currentUser.role === 'seller' ? 'block' : 'none';
    if (currentUser.role === 'buyer') {
      loadProducts(); // åˆ·æ–°å•†å“åˆ—è¡¨
    }
  } else {
    alert(msg ? msg.message : "è§’è‰²åˆ‡æ¢å¤±è´¥");
  }
}

// æ·»åŠ ä¾§è¾¹æ æ˜¾ç¤ºæ§åˆ¶
function updateSidebarVisibility() {
  const sidebar = document.querySelector('.sidebar');
  if (sidebar) {
    // å–å®¶çœ‹ä¸åˆ°ä¾§è¾¹æ ï¼ˆå› ä¸ºå·²ç»æœ‰å–å®¶ä¸­å¿ƒé¡µé¢äº†ï¼‰
    sidebar.style.display = 'none';
  }
}

// æ”¯ä»˜æ–¹å¼æ˜¾ç¤º
function getPaymentMethodText(method) {
  const methods = {
    'cash': 'ç°é‡‘æ”¯ä»˜',
    'credit_card': 'ä¿¡ç”¨å¡',
    'online_banking': 'ç½‘ä¸Šé“¶è¡Œ'
  };
  return methods[method] || method;
}

// æ”¯ä»˜çŠ¶æ€æ˜¾ç¤º
function getPaymentStatusText(status) {
  const statuses = {
    'pending': 'å¾…æ”¯ä»˜',
    'paid': 'å·²æ”¯ä»˜',
    'failed': 'æ”¯ä»˜å¤±è´¥'
  };
  return statuses[status] || status;
}

// åŠ è½½åˆ†ç±»å¹¶æ¸²æŸ“æˆæŒ‰é’®ï¼ˆä»åç«¯è·å–æ‰€æœ‰ categoriesï¼‰
async function loadCategories(){
  const bar = document.getElementById('categoriesBar');
  if(!bar) return;
  bar.innerHTML = '<button onclick="filterCategory(\'\')" data-i18n="categories.all">å…¨éƒ¨</button>';
  try{
    const data = await safeFetch('api.php?action=list_categories');
    if(!Array.isArray(data)) return;
    // Deduplicate category names (case-insensitive)
    const seen = new Set();
    data.forEach(cat=>{
      const rawName = cat.name || '';
      const name = String(rawName).trim();
      if(!name) return;
      const key = name.toLowerCase();
      if(seen.has(key)) return;
      seen.add(key);
      const btn = document.createElement('button');
      btn.textContent = name;
      btn.onclick = function(){ filterCategory(name); highlightCategory(name); };
      bar.appendChild(btn);
    });
    // highlight current
    highlightCategory(currentCategory || '');
  } catch(e){
    console.warn('åŠ è½½åˆ†ç±»å¤±è´¥', e);
  }
}

function highlightCategory(cat){
  const bar = document.getElementById('categoriesBar');
  if(!bar) return;
  bar.querySelectorAll('button').forEach(b=>{
    if(b.getAttribute('data-i18n') === 'categories.all' && cat === ''){
      b.style.background = '#f53d2d'; b.style.color='white';
    } else if(b.textContent === cat){
      b.style.background = '#f53d2d'; b.style.color='white';
    } else {
      b.style.background = '#eee'; b.style.color='';
    }
  });
}

// åˆå§‹åŒ–
showUser();
// load categories first, then products so category filters are available
loadCategories().then(()=> loadProducts());
updateSidebarVisibility(); // åˆå§‹åŒ–æ—¶è®¾ç½®ä¾§è¾¹æ æ˜¾ç¤ºçŠ¶æ€

// Mobile sidebar toggle for small screens
function toggleSidebarMobile(){
  const sb = document.querySelector('.sidebar');
  if(!sb) return;
  // toggle mobile-open class
  if(sb.classList.contains('mobile-open')){
    sb.classList.remove('mobile-open');
    // allow it to hide after transition
    setTimeout(()=>{ if(window.innerWidth <= 600) sb.style.display='none'; }, 300);
  } else {
    sb.style.display='block';
    // small delay to allow display before adding class
    setTimeout(()=> sb.classList.add('mobile-open'), 10);
  }
}

// Listen for category changes from other tabs (seller added/updated a category)
window.addEventListener('storage', function(e){
  if(e.key === 'categoriesUpdated'){
    loadCategories();
  }
});
</script>

<script src="i18n.js"></script>

</body>
</html>
<!-- Media viewer modal -->
<div id="mediaModal" class="modal" style="display:none;">
  <div class="modal-content" style="max-width:900px; max-height:90vh; overflow:hidden; position:relative;">
    <button onclick="closeMediaModal()" style="position:absolute;right:12px;top:10px;background:#fff;border:none;padding:6px 8px;border-radius:4px;cursor:pointer;z-index:20">å…³é—­</button>
    <div id="mediaViewer" style="display:flex;align-items:center;justify-content:center;height:100%;padding:12px"></div>
    <div style="position:absolute;left:12px;top:10px;color:#666;z-index:20" id="mediaViewerTitle"></div>
    <button id="mediaPrev" onclick="showMediaAt(currentMediaIndex-1)" style="position:absolute;left:10px;top:50%;transform:translateY(-50%);background:rgba(255,255,255,0.8);border:none;padding:8px;border-radius:50%;cursor:pointer;z-index:20">â—€</button>
    <button id="mediaNext" onclick="showMediaAt(currentMediaIndex+1)" style="position:absolute;right:50px;top:50%;transform:translateY(-50%);background:rgba(255,255,255,0.8);border:none;padding:8px;border-radius:50%;cursor:pointer;z-index:20">â–¶</button>
  </div>
</div>

<script>
let currentMediaList = [];
let currentMediaIndex = 0;

function openMediaModal(product, startIndex){
  try{
    // normalize media list
    let imgs = product.image || [];
    if(typeof imgs === 'string' && imgs.trim().startsWith('[')) imgs = JSON.parse(imgs);
    if(!Array.isArray(imgs)) imgs = [imgs];
    currentMediaList = imgs.map(i => String(i).replace(/\r?\n/g,'').trim()).filter(Boolean);
    if(currentMediaList.length === 0) return;
    currentMediaIndex = Math.max(0, Math.min(startIndex || 0, currentMediaList.length-1));
    document.getElementById('mediaViewerTitle').innerText = product.name || '';
    showMediaAt(currentMediaIndex);
    const modal = document.getElementById('mediaModal');
    modal.style.display = 'flex';
  }catch(e){ console.error(e); }
}

function closeMediaModal(){
  const modal = document.getElementById('mediaModal');
  modal.style.display = 'none';
  const viewer = document.getElementById('mediaViewer');
  viewer.innerHTML = '';
  currentMediaList = [];
  currentMediaIndex = 0;
}

function showMediaAt(idx){
  if(idx < 0) idx = 0;
  if(idx >= currentMediaList.length) idx = currentMediaList.length-1;
  currentMediaIndex = idx;
  const viewer = document.getElementById('mediaViewer');
  viewer.innerHTML = '';
  const item = currentMediaList[idx];
  if(!item) return;
  const ytMatch = item.match(/(?:youtube\.com\/(?:watch\?v=|embed\/)|youtu\.be\/)([A-Za-z0-9_-]{6,})/);
  if(ytMatch && ytMatch[1]){
    const id = ytMatch[1];
    viewer.innerHTML = `<iframe src="https://www.youtube.com/embed/${id}" frameborder="0" allowfullscreen style="width:100%;height:80vh"></iframe>`;
  } else if(item.match(/\.(jpg|jpeg|png|gif|webp)$/i) || item.startsWith('http') || item.indexOf('uploads/') === 0){
    viewer.innerHTML = `<img src="${item}" style="max-width:100%;max-height:80vh;display:block;margin:auto">`;
  } else if(item.match(/\.(mp4|webm|ogg|mov)$/i)){
    viewer.innerHTML = `<video src="${item}" controls style="max-width:100%;max-height:80vh;display:block;margin:auto" playsinline></video>`;
  } else {
    viewer.innerHTML = `<div style="padding:20px;background:#fff">${item}</div>`;
  }
  // update prev/next visibility
  document.getElementById('mediaPrev').style.display = currentMediaIndex > 0 ? 'block' : 'none';
  document.getElementById('mediaNext').style.display = currentMediaIndex < currentMediaList.length-1 ? 'block' : 'none';
}

// keyboard navigation
document.addEventListener('keydown', function(e){
  const modal = document.getElementById('mediaModal');
  if(!modal || modal.style.display === 'none') return;
  if(e.key === 'Escape') closeMediaModal();
  if(e.key === 'ArrowLeft') showMediaAt(currentMediaIndex-1);
  if(e.key === 'ArrowRight') showMediaAt(currentMediaIndex+1);
});
</script>