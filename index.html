<!DOCTYPE html>
<html lang="zh">
<head>
<meta charset="UTF-8">
<title>Shopee Clone ğŸ›ï¸</title>
<style>
body { font-family: 'Segoe UI', Arial, sans-serif; background: #fafafa; margin:0; display:flex; }
.sidebar { width:300px; padding:15px; border-left:1px solid #eee; background:#fff; height:100vh; box-shadow:-2px 0 5px rgba(0,0,0,0.05); }
main { flex:1; padding:20px; }
header { background: #f53d2d; color: white; display:flex; justify-content:space-between; align-items:center; padding:10px 15px; margin-bottom:10px; }
header h1 { margin:0; font-size:20px; }
header .user { font-size:14px; }
.search-bar { display:flex; margin-bottom:10px; }
.search-bar input { flex:1; padding:8px; border:1px solid #ddd; border-radius:6px 0 0 6px; }
.search-bar button { border:none; background:#f53d2d; color:white; padding:8px 12px; border-radius:0 6px 6px 0; cursor:pointer; }
.categories { display:flex; margin-bottom:10px; }
.categories button { margin-right:5px; padding:6px 10px; border:none; border-radius:5px; cursor:pointer; background:#eee; }
.products { display:flex; flex-wrap:wrap; }
.card { background:white; width:150px; margin:5px; border-radius:8px; box-shadow:0 2px 5px rgba(0,0,0,0.1); overflow:hidden; text-align:center; transition:transform 0.2s; padding:10px; }
.card:hover { transform:scale(1.05); }
.card h4 { margin:5px 0; font-size:14px; }
.card button { width:100%; border:none; background:#f53d2d; color:white; padding:6px; cursor:pointer; }
.cart { margin-top:10px; padding:10px; background:#f53d2d; color:white; border-radius:5px; cursor:pointer; text-align:center; }
.form-group { margin-bottom:10px; }
.form-group input { width:100%; padding:6px; border:1px solid #ddd; border-radius:4px; }
.form-group button { width:100%; padding:8px; border:none; background:#f53d2d; color:white; cursor:pointer; border-radius:4px; }
.order-card { background:white; padding:15px; margin-bottom:10px; border-radius:8px; box-shadow:0 2px 5px rgba(0,0,0,0.1); }
.order-card h4 { margin:0 0 10px 0; color:#f53d2d; }
.order-card .items { white-space:pre-line; margin:10px 0; padding:10px; background:#f8f8f8; border-radius:4px; }
.order-card .meta { color:#666; font-size:0.9em; }
.payment-methods { margin:15px 0; }
.payment-option { border:1px solid #ddd; margin-bottom:10px; padding:10px; border-radius:4px; cursor:pointer; }
.payment-option:hover { border-color:#f53d2d; }
.payment-option.selected { border-color:#f53d2d; background:#fff3f3; }
.payment-option label { display:flex; align-items:center; cursor:pointer; }
.payment-option .icon { font-size:24px; margin-right:10px; }
.payment-option .text { font-weight:bold; flex:1; }
.payment-option .desc { color:#666; font-size:0.9em; }
.payment-option input[type="radio"] { display:none; }
.payment-detail-form { margin-top:10px; padding:10px; background:#f8f8f8; border-radius:4px; }
</style>
</head>
<body>

<main>
<header>
  <h1>Shopee Clone ğŸ›’</h1>
  <div class="user" id="userDisplay">æœªç™»å½•</div>
</header>

<div class="search-bar">
  <input type="text" id="searchInput" placeholder="æœç´¢å•†å“...">
  <button onclick="searchProducts()">æœç´¢</button>
</div>

<div class="categories">
  <button onclick="filterCategory('')">å…¨éƒ¨</button>
  <button onclick="filterCategory('ç”µå­äº§å“')">ç”µå­äº§å“</button>
  <button onclick="filterCategory('é…ä»¶')">é…ä»¶</button>
  <button onclick="filterCategory('ç”Ÿæ´»ç”¨å“')">ç”Ÿæ´»ç”¨å“</button>
</div>

<div class="products" id="productContainer"></div>

<div style="display:flex; gap:10px;">
  <div class="cart" onclick="toggleCheckoutForm()">ğŸ›’ è´­ç‰©è½¦ (<span id="count">0</span>)</div>
  <div class="cart" onclick="toggleMyOrders()" style="background:#4CAF50">ğŸ“¦ æˆ‘çš„è®¢å•</div>
</div>

<div class="checkout-form" id="checkoutForm" style="display:none; margin-top:10px;">
  <h4>æ”¶ä»¶ä¿¡æ¯</h4>
  <div class="form-group">
    <input type="text" id="recipientName" placeholder="æ”¶ä»¶äººå§“å">
  </div>
  <div class="form-group">
    <input type="text" id="recipientAddress" placeholder="æ”¶è´§åœ°å€">
  </div>
  <h4>æ”¯ä»˜æ–¹å¼</h4>
  <div class="payment-methods">
    <div class="payment-option" onclick="selectPayment('cash')">
      <input type="radio" name="payment" value="cash" id="pay_cash" checked>
      <label for="pay_cash">
        <span class="icon">ğŸ’µ</span>
        <span class="text">ç°é‡‘æ”¯ä»˜</span>
        <span class="desc">è´§åˆ°ä»˜æ¬¾</span>
      </label>
    </div>
    <div class="payment-option" onclick="selectPayment('credit_card')">
      <input type="radio" name="payment" value="credit_card" id="pay_card">
      <label for="pay_card">
        <span class="icon">ğŸ’³</span>
        <span class="text">ä¿¡ç”¨å¡</span>
        <span class="desc">æ”¯æŒ Visa / Mastercard</span>
      </label>
    </div>
    <div class="payment-option" onclick="selectPayment('online_banking')">
      <input type="radio" name="payment" value="online_banking" id="pay_bank">
      <label for="pay_bank">
        <span class="icon">ğŸ¦</span>
        <span class="text">ç½‘ä¸Šé“¶è¡Œ</span>
        <span class="desc">æ”¯æŒæ‰€æœ‰å¤§é©¬é“¶è¡Œ</span>
      </label>
    </div>
  </div>
  <div id="payment_details" style="display:none;">
    <!-- ä¿¡ç”¨å¡è¡¨å• -->
    <div id="card_form" class="payment-detail-form">
      <div class="form-group">
        <input type="text" placeholder="å¡å·" maxlength="19" oninput="formatCardNumber(this)">
      </div>
      <div style="display:flex;gap:10px;">
        <div class="form-group">
          <input type="text" placeholder="æœ‰æ•ˆæœŸ MM/YY" maxlength="5">
        </div>
        <div class="form-group">
          <input type="text" placeholder="CVV" maxlength="3">
        </div>
      </div>
    </div>
    <!-- ç½‘é“¶è¡¨å• -->
    <div id="bank_form" class="payment-detail-form">
      <div class="form-group">
        <select style="width:100%; padding:6px;">
          <option value="">é€‰æ‹©é“¶è¡Œ</option>
          <option value="maybank">Maybank</option>
          <option value="cimb">CIMB Bank</option>
          <option value="public">Public Bank</option>
          <option value="rhb">RHB Bank</option>
        </select>
      </div>
    </div>
  </div>
  <div class="form-group">
    <button onclick="checkout()" style="margin-top:15px;">ç¡®è®¤ä¸‹å•</button>
  </div>
</div>

<!-- è®¢å•åˆ—è¡¨ -->
<div id="myOrders" style="display:none; margin-top:20px;">
  <h3>æˆ‘çš„è®¢å•è®°å½•</h3>
  <div id="ordersList"></div>
</div>

</main>

<div class="sidebar">
  <h4>å–å®¶åŠŸèƒ½</h4>
  <div class="form-group">
    <input type="text" id="productName" placeholder="å•†å“åç§°">
  </div>
  <div class="form-group">
    <input type="number" id="productPrice" placeholder="ä»·æ ¼">
  </div>
  <div class="form-group">
    <select id="productCategory" style="width:100%; padding:6px; border:1px solid #ddd; border-radius:4px;">
      <option value="">è¯·é€‰æ‹©åˆ†ç±»</option>
      <option value="1">ç”µå­äº§å“</option>
      <option value="2">é…ä»¶</option>
      <option value="3">ç”Ÿæ´»ç”¨å“</option>
    </select>
  </div>

  <div class="form-group">
    <input type="text" id="productDesc" placeholder="æè¿°">
  </div>
  <div class="form-group">
    <button onclick="addProduct()">æ·»åŠ å•†å“</button>
  </div>
</div>

<script>
let cart = [];
let currentUser = JSON.parse(localStorage.getItem("user")) || null;
let currentCategory = '';
let currentKeyword = '';

function showUser() {
  const userDiv = document.getElementById('userDisplay');
  if(currentUser){
    userDiv.innerHTML = `
      æ¬¢è¿å›æ¥ <b>${currentUser.username}</b> 
      <span style="margin:0 10px">(${currentUser.role === 'buyer' ? 'ä¹°å®¶' : 'å–å®¶'})</span>
      <button onclick="switchRole()" style="background:#fff; color:#f53d2d; border:none; padding:3px 8px; border-radius:4px; cursor:pointer">
        åˆ‡æ¢ä¸º${currentUser.role === 'buyer' ? 'å–å®¶' : 'ä¹°å®¶'}
      </button>
    `;
  } else {
    userDiv.innerHTML = `<a href="login.html" style="color:white;">ç™»å½• / æ³¨å†Œ</a>`;
  }
}

async function safeFetch(url, options){
  try{
    const res = await fetch(url, options);
    const text = await res.text();
    try { return JSON.parse(text);} catch { alert("è¿”å›éJSON"); return null;}
  } catch(err){ alert("ç½‘ç»œè¯·æ±‚å¤±è´¥:"+err.message); return null;}
}

async function loadProducts(){
  const data = await safeFetch(`api.php?category=${encodeURIComponent(currentCategory)}&search=${encodeURIComponent(currentKeyword)}`);
  if(!data) return;
  const container = document.getElementById('productContainer');
  container.innerHTML = '';
  data.forEach(p=>{
    container.innerHTML += `
      <div class="card">
        <h4>${p.name}</h4>
        <p>RM ${p.price}</p>
        <button onclick='addToCart(${JSON.stringify(p)})'>åŠ å…¥è´­ç‰©è½¦</button>
      </div>
    `;
  });
}

function addToCart(p){
  const found = cart.find(i=>i.id===p.id);
  if(found) found.quantity++;
  else cart.push({...p, quantity:1});
  document.getElementById('count').innerText = cart.reduce((a,b)=>a+b.quantity,0);
}

function toggleCheckoutForm(){
  const form = document.getElementById('checkoutForm');
  form.style.display = form.style.display==='none'?'block':'none';
  // éšè—è®¢å•åˆ—è¡¨
  document.getElementById('myOrders').style.display = 'none';
}

async function toggleMyOrders(){
  if(!currentUser) return alert('è¯·å…ˆç™»å½•');
  const ordersDiv = document.getElementById('myOrders');
  
  if(ordersDiv.style.display === 'none'){
    // åŠ è½½è®¢å•æ•°æ®
    const orders = await safeFetch(`api.php?action=my_orders&user_id=${currentUser.id}`);
    if(!orders) return;
    
    const ordersList = document.getElementById('ordersList');
    ordersList.innerHTML = orders.length ? orders.map(order => `
      <div class="order-card">
        <h4>è®¢å•å·: #${order.id}</h4>
        <div class="items">${order.items}</div>
        <div class="meta">
          <div>æ”¶ä»¶äºº: ${order.recipient_name}</div>
          <div>åœ°å€: ${order.recipient_address}</div>
          <div>æ€»ä»·: RM ${order.total_price}</div>
          <div>æ”¯ä»˜æ–¹å¼: ${getPaymentMethodText(order.payment_method)}</div>
          <div>æ”¯ä»˜çŠ¶æ€: ${getPaymentStatusText(order.payment_status)}</div>
          <div>ä¸‹å•æ—¶é—´: ${new Date(order.created_at).toLocaleString()}</div>
        </div>
      </div>
    `).join('') : '<p>æš‚æ— è®¢å•è®°å½•</p>';
    
    ordersDiv.style.display = 'block';
    // éšè—ç»“è´¦è¡¨å•
    document.getElementById('checkoutForm').style.display = 'none';
  } else {
    ordersDiv.style.display = 'none';
  }
}

// æ ¼å¼åŒ–ä¿¡ç”¨å¡å·
function formatCardNumber(input) {
  let value = input.value.replace(/\D/g, '');
  let formattedValue = '';
  for(let i = 0; i < value.length; i++) {
    if(i > 0 && i % 4 === 0) {
      formattedValue += ' ';
    }
    formattedValue += value[i];
  }
  input.value = formattedValue;
}

// é€‰æ‹©æ”¯ä»˜æ–¹å¼
function selectPayment(method) {
  // æ›´æ–°å•é€‰æ¡†
  document.querySelectorAll('.payment-option').forEach(opt => {
    opt.classList.remove('selected');
    if(opt.querySelector(`#pay_${method}`)) {
      opt.classList.add('selected');
      opt.querySelector(`#pay_${method}`).checked = true;
    }
  });

  // æ˜¾ç¤º/éšè—å¯¹åº”çš„æ”¯ä»˜è¯¦æƒ…è¡¨å•
  const detailsDiv = document.getElementById('payment_details');
  const cardForm = document.getElementById('card_form');
  const bankForm = document.getElementById('bank_form');

  if(method === 'credit_card') {
    detailsDiv.style.display = 'block';
    cardForm.style.display = 'block';
    bankForm.style.display = 'none';
  } else if(method === 'online_banking') {
    detailsDiv.style.display = 'block';
    cardForm.style.display = 'none';
    bankForm.style.display = 'block';
  } else {
    detailsDiv.style.display = 'none';
  }
}

async function checkout(){
  if(!currentUser || currentUser.role!=="buyer") return alert("è¯·ä½¿ç”¨ä¹°å®¶è´¦å·ç™»å½•ï¼");
  if(cart.length===0) return alert("è´­ç‰©è½¦ä¸ºç©ºï¼");
  const recipient_name = document.getElementById('recipientName').value.trim();
  const recipient_address = document.getElementById('recipientAddress').value.trim();
  if(!recipient_name || !recipient_address) return alert("è¯·å¡«å†™æ”¶ä»¶ä¿¡æ¯");

  // è·å–é€‰ä¸­çš„æ”¯ä»˜æ–¹å¼
  const payment_method = document.querySelector('input[name="payment"]:checked').value;
  
  // éªŒè¯æ”¯ä»˜ä¿¡æ¯
  if(payment_method === 'credit_card') {
    const cardInputs = document.querySelectorAll('#card_form input');
    for(let input of cardInputs) {
      if(!input.value.trim()) return alert("è¯·å¡«å†™å®Œæ•´çš„ä¿¡ç”¨å¡ä¿¡æ¯");
    }
  } else if(payment_method === 'online_banking') {
    const bankSelect = document.querySelector('#bank_form select');
    if(!bankSelect.value) return alert("è¯·é€‰æ‹©é“¶è¡Œ");
  }

  const itemsToSend = cart.map(p=>({id:p.id,price:p.price,quantity:p.quantity}));
  const msg = await safeFetch("api.php",{
    method:"POST",
    headers:{'Content-Type':'application/json'},
    body:JSON.stringify({
      action:"create_order",
      user_id:currentUser.id,
      items:itemsToSend,
      recipient_name,
      recipient_address,
      payment_method
    })
  });
  if(!msg) return;
  if(msg.status==="ok"){
    alert("è®¢å•åˆ›å»ºæˆåŠŸï¼");
    cart=[];
    document.getElementById('count').innerText=0;
    toggleCheckoutForm();
    loadProducts();
  } else alert("ä¸‹å•å¤±è´¥ï¼š"+msg.message);
}

async function addProduct(){
  if(!currentUser || currentUser.role!=="seller") return alert("è¯·ä½¿ç”¨å–å®¶è´¦å·ç™»å½•ï¼");
  const name = document.getElementById('productName').value.trim();
  const price = parseFloat(document.getElementById('productPrice').value);
  const category_id = parseInt(document.getElementById('productCategory').value);
  const description = document.getElementById('productDesc').value.trim();
  if(!name||!price||!category_id) return alert("è¯·å¡«å†™å®Œæ•´ä¿¡æ¯");

  const msg = await safeFetch("api.php",{
    method:"POST",
    headers:{'Content-Type':'application/json'},
    body:JSON.stringify({action:"add_product",name,price,category_id,seller_id:currentUser.id,image,description})
  });
  if(!msg) return;
  alert(msg.message);
  if(msg.status==="ok"){
    document.getElementById('productName').value='';
    document.getElementById('productPrice').value='';
    document.getElementById('productCategory').value='';
    document.getElementById('productDesc').value='';
    loadProducts();
  }
}

function searchProducts(){
  currentKeyword=document.getElementById('searchInput').value;
  loadProducts();
}

function filterCategory(cat){
  currentCategory=cat;
  loadProducts();
}

// åˆ‡æ¢è§’è‰²å‡½æ•°
async function switchRole() {
  if (!currentUser) return;
  
  const newRole = currentUser.role === 'buyer' ? 'seller' : 'buyer';
  const msg = await safeFetch("auth.php", {
    method: "POST",
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify({
      action: "switch_role",
      user_id: currentUser.id,
      role: newRole
    })
  });

  if (msg && msg.status === "ok") {
    currentUser = msg.user;
    localStorage.setItem("user", JSON.stringify(currentUser));
    showUser();
    // åˆ·æ–°é¡µé¢æ˜¾ç¤º
    document.querySelector('.sidebar').style.display = currentUser.role === 'seller' ? 'block' : 'none';
    if (currentUser.role === 'buyer') {
      loadProducts(); // åˆ·æ–°å•†å“åˆ—è¡¨
    }
  } else {
    alert(msg ? msg.message : "è§’è‰²åˆ‡æ¢å¤±è´¥");
  }
}

// æ·»åŠ ä¾§è¾¹æ æ˜¾ç¤ºæ§åˆ¶
function updateSidebarVisibility() {
  const sidebar = document.querySelector('.sidebar');
  if (sidebar) {
    sidebar.style.display = (currentUser && currentUser.role === 'seller') ? 'block' : 'none';
  }
}

// æ”¯ä»˜æ–¹å¼æ˜¾ç¤º
function getPaymentMethodText(method) {
  const methods = {
    'cash': 'ç°é‡‘æ”¯ä»˜',
    'credit_card': 'ä¿¡ç”¨å¡',
    'online_banking': 'ç½‘ä¸Šé“¶è¡Œ'
  };
  return methods[method] || method;
}

// æ”¯ä»˜çŠ¶æ€æ˜¾ç¤º
function getPaymentStatusText(status) {
  const statuses = {
    'pending': 'å¾…æ”¯ä»˜',
    'paid': 'å·²æ”¯ä»˜',
    'failed': 'æ”¯ä»˜å¤±è´¥'
  };
  return statuses[status] || status;
}

// åˆå§‹åŒ–
showUser();
loadProducts();
updateSidebarVisibility(); // åˆå§‹åŒ–æ—¶è®¾ç½®ä¾§è¾¹æ æ˜¾ç¤ºçŠ¶æ€
</script>

</body>
</html>
