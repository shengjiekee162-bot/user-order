<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<title>ç¤ºä¾‹å•†åŸ ğŸ›ï¸</title>
  <!-- å“åº”å¼è§†çª— -->
  <meta name="viewport" content="width=device-width, initial-scale=1">
<style>
body { font-family: 'Segoe UI', Arial, sans-serif; background: #fafafa; margin:0; display:flex; }
.sidebar { width:300px; padding:15px; border-left:1px solid #eee; background:#fff; height:100vh; box-shadow:-2px 0 5px rgba(0,0,0,0.05); }
main { flex:1; padding:20px; }
header { background: #f53d2d; color: white; display:flex; justify-content:space-between; align-items:center; padding:10px 15px; margin-bottom:10px; }
header h1 { margin:0; font-size:20px; }
header .user { font-size:14px; }
.search-bar { display:flex; margin-bottom:10px; }
.search-bar input { flex:1; padding:8px; border:1px solid #ddd; border-radius:6px 0 0 6px; }
.search-bar button { border:none; background:#f53d2d; color:white; padding:8px 12px; border-radius:0 6px 6px 0; cursor:pointer; }
.categories { display:flex; margin-bottom:10px; }
.categories button { margin-right:5px; padding:6px 10px; border:none; border-radius:5px; cursor:pointer; background:#eee; }
.products { display:flex; flex-wrap:wrap; }
.card { background:white; width:150px; margin:5px; border-radius:8px; box-shadow:0 2px 5px rgba(0,0,0,0.1); overflow:hidden; text-align:center; transition:transform 0.2s; padding:10px; }
.card:hover { transform:scale(1.05); }
.card h4 { margin:5px 0; font-size:14px; }
.card button { width:100%; border:none; background:#f53d2d; color:white; padding:6px; cursor:pointer; }
.cart { margin-top:10px; padding:10px; background:#f53d2d; color:white; border-radius:5px; cursor:pointer; text-align:center; }
.form-group { margin-bottom:10px; }
.form-group input { width:100%; padding:6px; border:1px solid #ddd; border-radius:4px; }
.form-group button { width:100%; padding:8px; border:none; background:#f53d2d; color:white; cursor:pointer; border-radius:4px; }
.order-card { background:white; padding:15px; margin-bottom:10px; border-radius:8px; box-shadow:0 2px 5px rgba(0,0,0,0.1); }
.order-card h4 { margin:0 0 10px 0; color:#f53d2d; }
.order-card .items { white-space:pre-line; margin:10px 0; padding:10px; background:#f8f8f8; border-radius:4px; }
.order-card .meta { color:#666; font-size:0.9em; }
.payment-methods { margin:15px 0; }
.payment-option { border:1px solid #ddd; margin-bottom:10px; padding:10px; border-radius:4px; cursor:pointer; }
.payment-option:hover { border-color:#f53d2d; }
.payment-option.selected { border-color:#f53d2d; background:#fff3f3; }
.payment-option label { display:flex; align-items:center; cursor:pointer; }
.payment-option .icon { font-size:24px; margin-right:10px; }
.payment-option .text { font-weight:bold; flex:1; }
.payment-option .desc { color:#666; font-size:0.9em; }
.payment-option input[type="radio"] { display:none; }
.payment-detail-form { margin-top:10px; padding:10px; background:#f8f8f8; border-radius:4px; }
/* Modal æ ·å¼ */
.modal { position:fixed; inset:0; background: rgba(0,0,0,0.45); display:flex; align-items:center; justify-content:center; z-index:999; }
.modal-content { background:#fff; padding:18px; width:80%; max-width:900px; border-radius:8px; box-shadow:0 6px 30px rgba(0,0,0,0.2); }
/* è®¢å•æ‘˜è¦æ ·å¼ */
#orderSummaryBody table { width:100%; border-collapse:collapse; }
#orderSummaryBody th, #orderSummaryBody td { padding:6px 8px; border-bottom:1px solid #eee; text-align:left; }
#orderSummaryBody .total { text-align:right; font-weight:bold; padding-top:8px; }

/* Mobile responsive rules */
@media (max-width: 900px) {
  body { flex-direction:column; }
  header { flex-wrap:wrap; padding:10px; }
  header h1 { flex:1 1 100%; font-size:18px; margin-bottom:8px; }
  .search-bar { order:3; width:100%; }
  .categories { order:4; width:100%; overflow:auto; }
  main { padding:12px; }
  .products { justify-content:center; }
  .card { width:45%; margin:6px; }
  .sidebar { width:100%; order:5; box-shadow:none; border-left:none; }
  .sidebar h4 { margin-top:0; }
  .cart { padding:12px; font-size:16px; }
}

@media (max-width: 600px) {
  .card { width:48%; }
  .sidebar { display:none; /* show via toggle */ }
  /* modal adapts to mobile full-screen, scrollable */
  .modal-content { width:95%; max-width:600px; height:90vh; overflow:auto; padding:12px; }
  .modal { align-items:flex-end; }
  header .mobile-sidebar-btn { display:inline-block; }
}

/* Sidebar overlay when opened on mobile */
.sidebar.mobile-open { display:block; position:fixed; right:0; top:0; height:100vh; width:80%; max-width:360px; background:#fff; box-shadow:-6px 0 30px rgba(0,0,0,0.2); z-index:1200; transform:translateX(0); }
.sidebar.mobile-hidden { transform:translateX(100%); }

.mobile-sidebar-btn { display:none; background:#fff; color:#f53d2d; border:none; padding:6px 8px; border-radius:4px; cursor:pointer; margin-right:8px; }
</style>
</style>
</head>
<body>

<main>
<header>
  <h1>ç¤ºä¾‹å•†åŸ ğŸ›’</h1>
  <div style="display:flex; align-items:center; gap:8px;">
    <button class="mobile-sidebar-btn" onclick="toggleSidebarMobile()" aria-label="æ‰“å¼€ä¾§è¾¹æ ">â˜°</button>
    <div class="user" id="userDisplay">æœªç™»å½•</div>
  </div>
</header>



<div class="search-bar">
  <input type="text" id="searchInput" placeholder="æœç´¢å•†å“...">
  <button onclick="searchProducts()">æœç´¢</button>
  <!-- æ‹ç…§æœç´¢æŒ‰é’®ï¼šéšè— file inputï¼Œä½¿ç”¨æŒ‰é’®è§¦å‘æ‹ç…§/ä¸Šä¼  -->
  <input type="file" id="imageInput" accept="image/*" capture="environment" style="display:none;" />
  <button onclick="document.getElementById('imageInput').click();" style="margin-left:8px; background:#fff; color:#f53d2d; border:1px solid #f53d2d; padding:6px 10px; border-radius:6px;">ğŸ“· æ‹ç…§æœç´¢</button>
</div>

<div class="categories">
  <button onclick="filterCategory('')">å…¨éƒ¨</button>
  <button onclick="filterCategory('ç”µå­äº§å“')">ç”µå­äº§å“</button>
  <button onclick="filterCategory('é…ä»¶')">é…ä»¶</button>
  <button onclick="filterCategory('ç”Ÿæ´»ç”¨å“')">ç”Ÿæ´»ç”¨å“</button>
</div>

<div class="products" id="productContainer"></div>

  <div style="display:flex; gap:10px;">
  <div class="cart" onclick="toggleCheckoutForm()">ğŸ›’ è´­ç‰©è½¦ (<span id="count">0</span>)</div>
  <div class="cart"><a href="orders.html" style="color:white; text-decoration:none; display:block;">ğŸ“¦ æˆ‘çš„è®¢å•</a></div>
  </div>

<!-- ç»“è´¦æ¨¡æ€å¼¹çª—ï¼ˆåˆå¹¶åœ°å€/æ”¯ä»˜/ä¸ªäººèµ„æ–™ï¼‰ -->
<div id="checkoutModal" class="modal" style="display:none;">
  <div class="modal-content">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
      <h3>ç»“è´¦ & æ”¯ä»˜</h3>
      <div>
        <span style="margin-right:10px; color:#666">å½“å‰ç”¨æˆ·: <b id="checkoutUser">æœªç™»å½•</b></span>
        <button onclick="showCheckoutTab()" style="background:#fff; border:1px solid #ddd; padding:6px 8px; border-radius:4px; margin-right:6px;">ç»“è´¦</button>
        <button onclick="showOrdersTab()" style="background:#fff; border:1px solid #ddd; padding:6px 8px; border-radius:4px; margin-right:6px;">æˆ‘çš„è®¢å•</button>
        <button onclick="toggleCheckoutForm()" style="background:#ddd; border:none; padding:6px 8px; border-radius:4px;">å…³é—­</button>
      </div>
    </div>

    <!-- è®¢å•æ‘˜è¦ï¼ˆæ˜¾ç¤ºè´­ç‰©è½¦é‡Œçš„å•†å“ï¼‰ -->
    <div id="orderSummary" style="margin-bottom:12px; display:none;">
      <h4>è®¢å•æ‘˜è¦</h4>
      <div id="orderSummaryBody" style="background:#fbfbfb; padding:10px; border-radius:6px;">
        <!-- JS å¡«å……è´­ç‰©è½¦å•†å“ -->
      </div>
    </div>

    <div style="display:flex; gap:20px;">
      <!-- å·¦ä¾§ï¼šåœ°å€é€‰æ‹©/æ·»åŠ  -->
      <div style="flex:1;">
        <h4>æ”¶ä»¶åœ°å€</h4>
        <div id="addressSelectArea" class="form-group">
          <select id="addressSelect" style="width:100%; padding:6px; border:1px solid #ddd; border-radius:4px;">
            <option value="">è¯·é€‰æ‹©æ”¶è´§åœ°å€</option>
          </select>
          <button onclick="showAddAddressForm()" style="margin-top:8px; width:100%; background:#4CAF50; color:white; border:none; border-radius:4px; padding:6px;">æ·»åŠ æ–°åœ°å€</button>
        </div>
        <div id="addAddressForm" style="display:none; margin-bottom:10px;">
          <input type="text" id="newRecipientName" placeholder="æ”¶ä»¶äººå§“å" style="margin-bottom:5px; width:100%; padding:6px; border:1px solid #ddd; border-radius:4px;">
          <input type="text" id="newRecipientAddress" placeholder="æ”¶è´§åœ°å€" style="margin-bottom:5px; width:100%; padding:6px; border:1px solid #ddd; border-radius:4px;">
          <label style="display:block; margin-bottom:5px;"><input type="checkbox" id="isDefaultAddress"> è®¾ä¸ºé»˜è®¤åœ°å€</label>
          <button onclick="addAddress()" style="width:100%; background:#f53d2d; color:white; border:none; border-radius:4px; padding:6px;">ä¿å­˜åœ°å€</button>
          <button onclick="hideAddAddressForm()" style="width:100%; background:#ddd; color:#333; border:none; border-radius:4px; padding:6px; margin-top:5px;">å–æ¶ˆ</button>
        </div>
      </div>

      <!-- å³ä¾§ï¼šæ”¯ä»˜æ–¹å¼ -->
      <div style="width:320px;">
        <h4>æ”¯ä»˜æ–¹å¼</h4>
        <div class="payment-methods">
          <div class="payment-option" onclick="selectPayment('cash')">
            <input type="radio" name="payment" value="cash" id="pay_cash" checked>
            <label for="pay_cash">
              <span class="icon">ğŸ’µ</span>
              <span class="text">ç°é‡‘æ”¯ä»˜</span>
              <span class="desc">è´§åˆ°ä»˜æ¬¾</span>
            </label>
          </div>
          <div class="payment-option" onclick="selectPayment('credit_card')">
            <input type="radio" name="payment" value="credit_card" id="pay_card">
            <label for="pay_card">
              <span class="icon">ğŸ’³</span>
              <span class="text">ä¿¡ç”¨å¡</span>
              <span class="desc">æ”¯æŒ Visa / Mastercard</span>
            </label>
          </div>
          <div class="payment-option" onclick="selectPayment('online_banking')">
            <input type="radio" name="payment" value="online_banking" id="pay_bank">
            <label for="pay_bank">
              <span class="icon">ğŸ¦</span>
              <span class="text">ç½‘ä¸Šé“¶è¡Œ</span>
              <span class="desc">æ”¯æŒæ‰€æœ‰å¤§é©¬é“¶è¡Œ</span>
            </label>
          </div>
        </div>
        <div id="payment_details" style="display:none;">
          <!-- ä¿¡ç”¨å¡è¡¨å• -->
          <div id="card_form" class="payment-detail-form">
            <div class="form-group">
              <input type="text" placeholder="å¡å·" maxlength="19" oninput="formatCardNumber(this)">
            </div>
            <div style="display:flex;gap:10px;">
              <div class="form-group">
                <input type="text" placeholder="æœ‰æ•ˆæœŸ MM/YY" maxlength="5">
              </div>
              <div class="form-group">
                <input type="text" placeholder="CVV" maxlength="3">
              </div>
            </div>
          </div>
          <!-- ç½‘é“¶è¡¨å• -->
          <div id="bank_form" class="payment-detail-form">
            <div class="form-group">
              <select id="bankSelect" style="width:100%; padding:6px;">
                <option value="">é€‰æ‹©é“¶è¡Œ</option>
                <option value="maybank">Maybank</option>
                <option value="cimb">CIMB Bank</option>
                <option value="public">Public Bank</option>
                <option value="rhb">RHB Bank</option>
              </select>
            </div>
          </div>
        </div>

        <div class="form-group" style="margin-top:12px;">
          <button onclick="checkout()" style="margin-top:5px; width:100%;">ç¡®è®¤ä¸‹å•</button>
        </div>
      </div>
    </div>
  </div>
</div>

    <!-- è®¢å•åŒºåŸŸï¼ˆåŒ modal å†…ï¼‰ -->
    <div id="ordersSection" style="display:none; margin-top:12px;">
      <h3>æˆ‘çš„è®¢å•è®°å½•</h3>
      <div id="ordersListModal"></div>
    </div>

</main>

  <div class="sidebar" style="display:none;">
  <h4>å–å®¶åŠŸèƒ½</h4>
  <p style="color:#666; text-align:center;">è¯·è®¿é—® <a href="seller.html" style="color:#f53d2d; font-weight:bold;">å–å®¶ä¸­å¿ƒ</a> ç®¡ç†æ‚¨çš„å•†å“</p>
</div><script>
let cart = [];
let currentUser = JSON.parse(localStorage.getItem("user")) || null;
let currentCategory = '';
let currentKeyword = '';
let addressList = [];
let selectedAddressId = '';

// åœ°å€ç®¡ç†ç›¸å…³
async function loadAddresses() {
  if (!currentUser) return;
  const res = await safeFetch(`api.php?action=list_addresses&user_id=${currentUser.id}`);
  addressList = Array.isArray(res) ? res : [];
  const select = document.getElementById('addressSelect');
  select.innerHTML = '<option value="">è¯·é€‰æ‹©æ”¶è´§åœ°å€</option>';
  addressList.forEach(addr => {
    select.innerHTML += `<option value="${addr.id}"${addr.is_default ? ' selected' : ''}>${addr.recipient_name} - ${addr.recipient_address}${addr.is_default ? 'ï¼ˆé»˜è®¤ï¼‰' : ''}</option>`;
    if (addr.is_default) selectedAddressId = addr.id;
  });
}

function showAddAddressForm() {
  document.getElementById('addAddressForm').style.display = 'block';
}
function hideAddAddressForm() {
  document.getElementById('addAddressForm').style.display = 'none';
}

async function addAddress() {
  const name = document.getElementById('newRecipientName').value.trim();
  const address = document.getElementById('newRecipientAddress').value.trim();
  const isDefault = document.getElementById('isDefaultAddress').checked ? 1 : 0;
  if (!name || !address) return alert('è¯·å¡«å†™å®Œæ•´åœ°å€ä¿¡æ¯');
  const res = await safeFetch('api.php', {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify({
      action: 'add_address',
      user_id: currentUser.id,
      recipient_name: name,
      recipient_address: address,
      is_default: isDefault
    })
  });
  if (res && res.status === 'ok') {
    alert('åœ°å€å·²ä¿å­˜');
    hideAddAddressForm();
    document.getElementById('newRecipientName').value = '';
    document.getElementById('newRecipientAddress').value = '';
    document.getElementById('isDefaultAddress').checked = false;
    await loadAddresses();
  } else {
    alert(res && res.message ? res.message : 'ä¿å­˜å¤±è´¥');
  }
}

document.getElementById('addressSelect').addEventListener('change', function() {
  selectedAddressId = this.value;
});

function showUser() {
  const userDiv = document.getElementById('userDisplay');
  if(currentUser){
    let html = `
      æ¬¢è¿å›æ¥ <b>${currentUser.username}</b> 
      <span style="margin:0 10px">(${currentUser.role === 'buyer' ? 'ä¹°å®¶' : 'å–å®¶'})</span>
    `;
    if(currentUser.role === 'seller') {
      html += `<button onclick="window.location.href='seller.html'" style="background:#fff; color:#f53d2d; border:none; padding:3px 8px; border-radius:4px; cursor:pointer; margin-right:5px;">
        å–å®¶ä¸­å¿ƒ
      </button>`;
    }
    html += `<button onclick="switchRole()" style="background:#fff; color:#f53d2d; border:none; padding:3px 8px; border-radius:4px; cursor:pointer">
      åˆ‡æ¢ä¸º${currentUser.role === 'buyer' ? 'å–å®¶' : 'ä¹°å®¶'}
    </button>`;
    html += `<button onclick="logout()" style="background:#fff; color:#f53d2d; border:none; padding:3px 8px; border-radius:4px; cursor:pointer; margin-left:6px;">é€€å‡ºç™»å½•</button>`;
    userDiv.innerHTML = html;
  } else {
    userDiv.innerHTML = `<a href="login.html" style="color:white;">ç™»å½• / æ³¨å†Œ</a> Â· <a href="forgot_password.html" style="color:white;">å¿˜è®°å¯†ç </a>`;
  }
}

// é€€å‡ºç™»å½•ï¼šæ¸…é™¤ localStorage å¹¶è·³è½¬åˆ°ç™»å½•é¡µ
function logout(){
  localStorage.removeItem('user');
  window.location.href = 'login.html';
}

async function safeFetch(url, options){
  try{
    const res = await fetch(url, options);
    const text = await res.text();
    try { return JSON.parse(text);} catch { alert("è¿”å›éJSON"); return null;}
  } catch(err){ alert("ç½‘ç»œè¯·æ±‚å¤±è´¥:"+err.message); return null;}
}

// åŠ è½½å–å®¶çš„å•†å“åˆ—è¡¨
async function loadMyProducts() {
  // æ­¤åŠŸèƒ½å·²ç§»è‡³ seller.html
}

// å¼€å§‹ç¼–è¾‘å•†å“
async function editProduct(productId) {
  // æ­¤åŠŸèƒ½å·²ç§»è‡³ seller.html
}

// å–æ¶ˆç¼–è¾‘
function cancelEdit() {
  // æ­¤åŠŸèƒ½å·²ç§»è‡³ seller.html
}

// æ·»åŠ æˆ–æ›´æ–°å•†å“
async function addProduct(){
  // æ­¤åŠŸèƒ½å·²ç§»è‡³ seller.html
}

async function loadProducts(){
  const data = await safeFetch(`api.php?category=${encodeURIComponent(currentCategory)}&search=${encodeURIComponent(currentKeyword)}`);
  if(!data) return;
  const container = document.getElementById('productContainer');
  container.innerHTML = '';
  data.forEach(p=>{
    container.innerHTML += `
      <div class="card">
        <h4>${p.name}</h4>
        <p>RM ${p.price}</p>
        <button onclick='addToCart(${JSON.stringify(p)})'>åŠ å…¥è´­ç‰©è½¦</button>
      </div>
    `;
  });
}

// æ‹ç…§æœç´¢ï¼šä¸Šä¼ å›¾ç‰‡åˆ°åç«¯å¹¶æ˜¾ç¤ºæœç´¢ç»“æœ
document.getElementById('imageInput').addEventListener('change', async function(e){
  const file = e.target.files[0];
  if(!file) return;
  const imgPreview = document.createElement('div');
  imgPreview.style.margin = '10px 0';
  imgPreview.innerHTML = `<div style="margin-bottom:6px">æ­£åœ¨ä¸Šä¼ å›¾ç‰‡å¹¶æœç´¢ç›¸ä¼¼å•†å“...</div>`;
  const container = document.getElementById('productContainer');
  container.prepend(imgPreview);

  const fd = new FormData();
  fd.append('image', file);

  try{
    const res = await fetch('image_search.php', { method: 'POST', body: fd });
    const data = await res.json();
    imgPreview.remove();
    if(!data) return alert('æœç´¢å¤±è´¥');
    if(data.message) {
      // æœåŠ¡ç«¯å¯èƒ½è¿”å›ä¿¡æ¯
      console.info('image_search:', data.message);
    }
    // data.products æœŸæœ›ä¸ºæ•°ç»„
    const products = Array.isArray(data.products) ? data.products : [];
    if(products.length === 0){
      container.innerHTML = '<p style="color:#999">æœªæ‰¾åˆ°ç›¸ä¼¼å•†å“ï¼Œæ˜¾ç¤ºå…¨éƒ¨å•†å“ä½œä¸ºå›é€€ã€‚</p>';
      await loadProducts();
      return;
    }
    // æ¸²æŸ“ç»“æœ
    container.innerHTML = '';
    products.forEach(p=>{
      container.innerHTML += `
      <div class="card">
        <h4>${escapeHtml(p.name)}</h4>
        <p>RM ${p.price}</p>
        <button onclick='addToCart(${JSON.stringify(p)})'>åŠ å…¥è´­ç‰©è½¦</button>
      </div>
    `;
    });
  } catch(err){
    imgPreview.remove();
    alert('ä¸Šä¼ æˆ–æœç´¢å¤±è´¥: ' + err.message);
  } finally{
    // æ¸…ç©º input ä»¥ä¾¿åç»­å¯é‡å¤é€‰æ‹©åŒä¸€æ–‡ä»¶
    e.target.value = '';
  }
});

function addToCart(p){
  const found = cart.find(i=>i.id===p.id);
  if(found) found.quantity++;
  else cart.push({...p, quantity:1});
  document.getElementById('count').innerText = cart.reduce((a,b)=>a+b.quantity,0);
}

// æ¸²æŸ“è®¢å•æ‘˜è¦ï¼ˆåœ¨ç»“è´¦æ—¶æ˜¾ç¤ºè´­ç‰©è½¦å†…å®¹ï¼‰
function renderOrderSummary(){
  const container = document.getElementById('orderSummaryBody');
  if(!container) return;
  if(!cart || cart.length===0){
    container.innerHTML = '<p>è´­ç‰©è½¦ä¸ºç©º</p>';
    document.getElementById('orderSummary').style.display = 'none';
    return;
  }
  document.getElementById('orderSummary').style.display = 'block';
  let total = 0;
  let html = '<table><thead><tr><th>å•†å“</th><th>å•ä»·</th><th>æ•°é‡</th><th>å°è®¡</th></tr></thead><tbody>';
  cart.forEach(it=>{
    const subtotal = parseFloat(it.price) * parseInt(it.quantity);
    total += subtotal;
    html += `<tr><td>${escapeHtml(it.name)}</td><td>RM ${parseFloat(it.price).toFixed(2)}</td><td>${it.quantity}</td><td>RM ${subtotal.toFixed(2)}</td></tr>`;
  });
  html += `</tbody></table><div class="total">æ€»è®¡: RM ${total.toFixed(2)}</div>`;
  container.innerHTML = html;
}

// ç®€å•è½¬ä¹‰æ–‡æœ¬ï¼Œé˜²æ­¢ XSSï¼ˆè´­ç‰©è½¦æ•°æ®æ¥è‡ªæœ¬ç«™ï¼‰
function escapeHtml(str){
  if(!str) return '';
  return String(str).replace(/[&<>"']/g, function(s){
    return {'&':'&a mp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[s];
  });
}

async function toggleCheckoutForm(){
  const modal = document.getElementById('checkoutModal');
  const ordersDiv = document.getElementById('myOrders');
  if(modal.style.display === 'none' || modal.style.display === ''){
    // æ‰“å¼€æ¨¡æ€ï¼šåŠ è½½åœ°å€å¹¶åˆå§‹åŒ–è§†å›¾
    if(!currentUser) return alert('è¯·å…ˆç™»å½•');
    document.getElementById('checkoutUser').innerText = currentUser.username || 'æœªçŸ¥ç”¨æˆ·';
    await loadAddresses();
    // è®¾ç½®ä¸‹æ‹‰ä¸ºé»˜è®¤åœ°å€ï¼ˆå¦‚æœæœ‰ï¼‰
    const select = document.getElementById('addressSelect');
    try{ select.value = selectedAddressId || ''; }catch(e){}
  // é»˜è®¤æ”¯ä»˜æ–¹å¼ä¸ºç°é‡‘
  selectPayment('cash');
  // ç¡®ä¿æ˜¾ç¤ºç»“è´¦ï¼ˆéè®¢å•ï¼‰é¡µç­¾
  showCheckoutTab();
  // æ¸²æŸ“è®¢å•æ‘˜è¦
  renderOrderSummary();
    // éšè—è®¢å•åˆ—è¡¨
    if(ordersDiv) ordersDiv.style.display = 'none';
    modal.style.display = 'flex';
  } else {
    modal.style.display = 'none';
  }
}

async function openOrdersModal(){
  if(!currentUser) return alert('è¯·å…ˆç™»å½•');
  const modal = document.getElementById('checkoutModal');
  document.getElementById('checkoutUser').innerText = currentUser.username || 'æœªçŸ¥ç”¨æˆ·';
  // æ˜¾ç¤º modal å¹¶åˆ‡æ¢åˆ°è®¢å•åŒºåŸŸ
  await loadAddresses();
  // show orders section
  showOrdersTab();
  modal.style.display = 'flex';
}

async function showOrdersTab(){
  const checkoutSection = document.querySelector('.modal-content > div:nth-child(2)');
  // éšè—å·¦/right checkout layout
  // ç›´æ¥å±•ç¤ºè®¢å•åˆ—è¡¨åŒºåŸŸ
  document.getElementById('ordersSection').style.display = 'block';
  document.getElementById('addressSelectArea').style.display = 'none';
  document.getElementById('payment_details').style.display = 'none';
  // åŠ è½½è®¢å•
  const orders = await safeFetch(`api.php?action=my_orders&user_id=${currentUser.id}`);
  if(!orders) return;
  const list = document.getElementById('ordersListModal');
  list.innerHTML = orders.length ? orders.map(order => `
    <div class="order-card">
      <h4>è®¢å•å·: #${order.id}</h4>
      <div class="items">${order.items}</div>
      <div class="meta">
        <div>æ”¶ä»¶äºº: ${order.recipient_name}</div>
        <div>åœ°å€: ${order.recipient_address}</div>
        <div>æ€»ä»·: RM ${order.total_price}</div>
        <div>æ”¯ä»˜æ–¹å¼: ${getPaymentMethodText(order.payment_method)}</div>
        <div>æ”¯ä»˜çŠ¶æ€: ${getPaymentStatusText(order.payment_status)}</div>
        <div>ä¸‹å•æ—¶é—´: ${new Date(order.created_at).toLocaleString()}</div>
      </div>
    </div>
  `).join('') : '<p>æš‚æ— è®¢å•è®°å½•</p>';
}

function showCheckoutTab(){
  // æ¢å¤åœ°å€/æ”¯ä»˜ç•Œé¢
  document.getElementById('ordersSection').style.display = 'none';
  document.getElementById('addressSelectArea').style.display = 'block';
  selectPayment('cash');
  // æ›´æ–°è®¢å•æ‘˜è¦å†…å®¹
  renderOrderSummary();
}

// æ ¼å¼åŒ–ä¿¡ç”¨å¡å·
function formatCardNumber(input) {
  let value = input.value.replace(/\D/g, '');
  let formattedValue = '';
  for(let i = 0; i < value.length; i++) {
    if(i > 0 && i % 4 === 0) {
      formattedValue += ' ';
    }
    formattedValue += value[i];
  }
  input.value = formattedValue;
}

// é€‰æ‹©æ”¯ä»˜æ–¹å¼
function selectPayment(method) {
  // æ›´æ–°å•é€‰æ¡†
  document.querySelectorAll('.payment-option').forEach(opt => {
    opt.classList.remove('selected');
    if(opt.querySelector(`#pay_${method}`)) {
      opt.classList.add('selected');
      opt.querySelector(`#pay_${method}`).checked = true;
    }
  });

  // æ˜¾ç¤º/éšè—å¯¹åº”çš„æ”¯ä»˜è¯¦æƒ…è¡¨å•
  const detailsDiv = document.getElementById('payment_details');
  const cardForm = document.getElementById('card_form');
  const bankForm = document.getElementById('bank_form');

  if(method === 'credit_card') {
    detailsDiv.style.display = 'block';
    cardForm.style.display = 'block';
    bankForm.style.display = 'none';
  } else if(method === 'online_banking') {
    detailsDiv.style.display = 'block';
    cardForm.style.display = 'none';
    bankForm.style.display = 'block';
  } else {
    detailsDiv.style.display = 'none';
  }
}

async function checkout(){
  if(!currentUser || currentUser.role!=="buyer") return alert("è¯·ä½¿ç”¨ä¹°å®¶è´¦å·ç™»å½•ï¼");
  if(cart.length===0) return alert("è´­ç‰©è½¦ä¸ºç©ºï¼");
  // è·å–é€‰ä¸­çš„åœ°å€
  const addr = addressList.find(a => a.id == selectedAddressId);
  if (!addr) return alert('è¯·é€‰æ‹©æ”¶è´§åœ°å€');
  const recipient_name = addr.recipient_name;
  const recipient_address = addr.recipient_address;

  // è·å–é€‰ä¸­çš„æ”¯ä»˜æ–¹å¼
  const payment_method = document.querySelector('input[name="payment"]:checked').value;
  
  // éªŒè¯æ”¯ä»˜ä¿¡æ¯
  if(payment_method === 'credit_card') {
    const cardInputs = document.querySelectorAll('#card_form input');
    for(let input of cardInputs) {
      if(!input.value.trim()) return alert("è¯·å¡«å†™å®Œæ•´çš„ä¿¡ç”¨å¡ä¿¡æ¯");
    }
  } else if(payment_method === 'online_banking') {
    const bankSelect = document.querySelector('#bank_form select');
    if(!bankSelect.value) return alert("è¯·é€‰æ‹©é“¶è¡Œ");
  }

  const itemsToSend = cart.map(p=>({id:p.id,price:p.price,quantity:p.quantity}));
  const msg = await safeFetch("api.php",{
    method:"POST",
    headers:{'Content-Type':'application/json'},
    body:JSON.stringify({
      action:"create_order",
      user_id:currentUser.id,
      items:itemsToSend,
      recipient_name,
      recipient_address,
      payment_method
    })
  });
  if(!msg) return;
  if(msg.status==="ok"){
    alert("è®¢å•åˆ›å»ºæˆåŠŸï¼");
    cart=[];
    document.getElementById('count').innerText=0;
    toggleCheckoutForm();
    loadProducts();
  } else alert("ä¸‹å•å¤±è´¥ï¼š"+msg.message);
}

async function addProduct(){
  if(!currentUser || currentUser.role!=="seller") return alert("è¯·ä½¿ç”¨å–å®¶è´¦å·ç™»å½•ï¼");
  const name = document.getElementById('productName').value.trim();
  const price = parseFloat(document.getElementById('productPrice').value);
  const category_id = parseInt(document.getElementById('productCategory').value);
  const description = document.getElementById('productDesc').value.trim();
  if(!name||!price||!category_id) return alert("è¯·å¡«å†™å®Œæ•´ä¿¡æ¯");

  const msg = await safeFetch("api.php",{
    method:"POST",
    headers:{'Content-Type':'application/json'},
    body:JSON.stringify({action:"add_product",name,price,category_id,seller_id:currentUser.id,description})
  });
  if(!msg) return;
  alert(msg.message);
  if(msg.status==="ok"){
    document.getElementById('productName').value='';
    document.getElementById('productPrice').value='';
    document.getElementById('productCategory').value='';
    document.getElementById('productDesc').value='';
    loadProducts();
  }
}

function searchProducts(){
  currentKeyword=document.getElementById('searchInput').value;
  loadProducts();
}

function filterCategory(cat){
  currentCategory=cat;
  loadProducts();
}

// åˆ‡æ¢è§’è‰²å‡½æ•°
async function switchRole() {
  if (!currentUser) return;
  
  const newRole = currentUser.role === 'buyer' ? 'seller' : 'buyer';
  const msg = await safeFetch("auth.php", {
    method: "POST",
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify({
      action: "switch_role",
      user_id: currentUser.id,
      role: newRole
    })
  });

  if (msg && msg.status === "ok") {
    currentUser = msg.user;
    localStorage.setItem("user", JSON.stringify(currentUser));
    showUser();
    // åˆ·æ–°é¡µé¢æ˜¾ç¤º
    document.querySelector('.sidebar').style.display = currentUser.role === 'seller' ? 'block' : 'none';
    if (currentUser.role === 'buyer') {
      loadProducts(); // åˆ·æ–°å•†å“åˆ—è¡¨
    }
  } else {
    alert(msg ? msg.message : "è§’è‰²åˆ‡æ¢å¤±è´¥");
  }
}

// æ·»åŠ ä¾§è¾¹æ æ˜¾ç¤ºæ§åˆ¶
function updateSidebarVisibility() {
  const sidebar = document.querySelector('.sidebar');
  if (sidebar) {
    // å–å®¶çœ‹ä¸åˆ°ä¾§è¾¹æ ï¼ˆå› ä¸ºå·²ç»æœ‰å–å®¶ä¸­å¿ƒé¡µé¢äº†ï¼‰
    sidebar.style.display = 'none';
  }
}

// æ”¯ä»˜æ–¹å¼æ˜¾ç¤º
function getPaymentMethodText(method) {
  const methods = {
    'cash': 'ç°é‡‘æ”¯ä»˜',
    'credit_card': 'ä¿¡ç”¨å¡',
    'online_banking': 'ç½‘ä¸Šé“¶è¡Œ'
  };
  return methods[method] || method;
}

// æ”¯ä»˜çŠ¶æ€æ˜¾ç¤º
function getPaymentStatusText(status) {
  const statuses = {
    'pending': 'å¾…æ”¯ä»˜',
    'paid': 'å·²æ”¯ä»˜',
    'failed': 'æ”¯ä»˜å¤±è´¥'
  };
  return statuses[status] || status;
}

// åˆå§‹åŒ–
showUser();
loadProducts();
updateSidebarVisibility(); // åˆå§‹åŒ–æ—¶è®¾ç½®ä¾§è¾¹æ æ˜¾ç¤ºçŠ¶æ€

// Mobile sidebar toggle for small screens
function toggleSidebarMobile(){
  const sb = document.querySelector('.sidebar');
  if(!sb) return;
  // toggle mobile-open class
  if(sb.classList.contains('mobile-open')){
    sb.classList.remove('mobile-open');
    // allow it to hide after transition
    setTimeout(()=>{ if(window.innerWidth <= 600) sb.style.display='none'; }, 300);
  } else {
    sb.style.display='block';
    // small delay to allow display before adding class
    setTimeout(()=> sb.classList.add('mobile-open'), 10);
  }
}
</script>

</body>
</html>