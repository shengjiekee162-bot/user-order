<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="utf-8">
  <title>我的订单</title>
  <style>
    :root{
      --bg-1: #040612;
      --bg-2: #0b1230;
      --accent-a: #00d4ff;
      --accent-b: #b464ff;
      --muted: #98a3b8;
      --panel: #071126;
    }

    html,body{height:100%;}
    body{font-family: system-ui, -apple-system, 'Segoe UI', Roboto, Arial; margin:0; padding:28px; background: radial-gradient(1200px 600px at 10% 10%, #07102a 0%, #040612 25%, #020012 60%), linear-gradient(180deg,var(--bg-1),var(--bg-2)); color:#eaf6ff}

    header{background:linear-gradient(90deg, rgba(138,59,255,0.12), rgba(0,212,255,0.06));color:#e8f7ff;padding:14px 20px;border-radius:10px;box-shadow:0 8px 30px rgba(138,59,255,0.06);margin-bottom:18px}
    header h1{margin:0;font-size:18px;color:#fff}

    .container{max-width:1000px;margin:0 auto}

    .order-card{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(0,0,0,0.22));padding:16px;border-radius:10px;box-shadow:0 10px 30px rgba(3,6,20,0.6);margin-bottom:12px;border:1px solid rgba(138,59,255,0.06)}
    .order-card h4{margin:0 0 8px;color:var(--accent-a);font-size:16px}
    .items{white-space:pre-line;background:rgba(255,255,255,0.02);padding:12px;border-radius:8px;margin-bottom:8px;color:var(--muted)}
    .meta{color:var(--muted);font-size:0.95em}
    .login-prompt{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(0,0,0,0.16));padding:20px;border-radius:10px;text-align:center;border:1px solid rgba(138,59,255,0.06)}
    a.button{display:inline-block;padding:8px 12px;background:linear-gradient(90deg,var(--accent-a),var(--accent-b));color:#031026;border-radius:8px;text-decoration:none;font-weight:700}

    .detail-modal{position:fixed;inset:0;background:rgba(0,0,0,0.65);display:none;align-items:center;justify-content:center;z-index:2000}
    .detail-content{background:linear-gradient(180deg,#071126,#041026);padding:18px;border-radius:12px;max-width:760px;width:92%;box-shadow:0 30px 80px rgba(3,6,20,0.9);border:1px solid rgba(138,59,255,0.08);color:#eaf6ff}
    .close-btn{background:#0b1220;color:var(--accent-a);border:none;padding:8px 10px;border-radius:8px;cursor:pointer}

    table{width:100%;border-collapse:collapse;margin-top:8px}
    th,td{border:1px solid rgba(255,255,255,0.04);padding:10px;text-align:left;color:var(--muted)}
    th{background:rgba(255,255,255,0.02);color:#eaf6ff}

    @media (max-width:700px){ body{padding:12px} .detail-content{width:96%} }
  </style>
</head>
<body>
  <header>
    <div class="container" style="display:flex; justify-content:space-between; align-items:center;">
      <h1>我的订单</h1>
      <div id="userArea"></div>
    </div>
  </header>

  <div class="container" id="main">
    <div id="content"></div>
  </div>

  <!-- 详情模态 -->
  <div id="detailModal" class="detail-modal">
    <div class="detail-content">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
        <h3 id="detailTitle">订单详情</h3>
        <button class="close-btn" onclick="closeDetail()">关闭</button>
      </div>
      <div id="detailBody"></div>
    </div>
  </div>

  <script>
    // Helpers
    function safeFetch(url, options){
      return fetch(url, options).then(r=>r.text()).then(t=>{try{return JSON.parse(t)}catch(e){alert('返回非JSON');return null}}).catch(e=>{alert('网络请求失败:'+e.message);return null});
    }

    function getPaymentMethodText(method){const m={'cash':'现金支付','credit_card':'信用卡','online_banking':'网上银行'};return m[method]||method}
    function getPaymentStatusText(s){const t={'pending':'待支付','paid':'已支付','failed':'支付失败'};return t[s]||s}

    // 渲染订单列表，包含查看详情按钮
    function renderOrders(orders){
      const content=document.getElementById('content');
      if(!orders || orders.length===0){
        content.innerHTML = '<div class="login-prompt">暂无订单记录<br><br><a href="index.html" class="button">返回商店</a></div>';
        return;
      }
      content.innerHTML = orders.map(o=>`
        <div class="order-card">
          <h4>订单号: #${o.id}</h4>
          <div class="items">${o.items}</div>
          <div class="meta">
            <div>收件人: ${o.recipient_name}</div>
            <div>地址: ${o.recipient_address}</div>
            <div>总价: RM ${o.total_price}</div>
            <div>支付方式: ${getPaymentMethodText(o.payment_method)}</div>
            <div>支付状态: ${getPaymentStatusText(o.payment_status)}</div>
            <div>下单时间: ${new Date(o.created_at).toLocaleString()}</div>
            <div style="margin-top:8px"><button onclick="openDetail(${o.id})" class="button">查看详情</button></div>
          </div>
        </div>
      `).join('');
    }

    // 打开详情模态并拉取详情
    async function openDetail(orderId){
      const res = await safeFetch(`api.php?action=order_detail&order_id=${orderId}`);
      if(!res) return;
      const title = document.getElementById('detailTitle');
      const body = document.getElementById('detailBody');
      title.innerText = `订单 #${res.order.id} 的详情`;
      let html = `<p>收件人: ${res.order.recipient_name} <br> 地址: ${res.order.recipient_address} <br> 总价: RM ${res.order.total_price} <br> 下单时间: ${res.order.created_at} <br> 支付方式: ${getPaymentMethodText(res.order.payment_method)} <br> 支付状态: ${getPaymentStatusText(res.order.payment_status)}</p>`;
      html += `<table><tr><th>商品ID</th><th>名称</th><th>单价</th><th>数量</th><th>小计</th></tr>`;
      res.items.forEach(it=>{
        const subtotal = (parseFloat(it.price) * parseInt(it.quantity)).toFixed(2);
        html += `<tr><td>${it.product_id}</td><td>${it.name}</td><td>RM ${it.price}</td><td>${it.quantity}</td><td>RM ${subtotal}</td></tr>`;
      });
      html += '</table>';
      body.innerHTML = html;
      document.getElementById('detailModal').style.display = 'flex';
    }
    function closeDetail(){ document.getElementById('detailModal').style.display = 'none'; }

    // Load orders for current user
    (async function(){
      const user = JSON.parse(localStorage.getItem('user')||'null');
      // render user area with logout if logged in
      const userArea = document.getElementById('userArea');
      if(user){
        userArea.innerHTML = `欢迎，<b>${user.username}</b> <button onclick="logout()" class="button" style="margin-left:8px;background:#fff;color:#f53d2d;border:1px solid #f53d2d;padding:6px 8px;border-radius:6px;">退出登录</button>`;
      } else {
        userArea.innerHTML = `<a href="login.html" class="button">登录</a>`;
      }
      const content=document.getElementById('content');
      if(!user){
        content.innerHTML = '<div class="login-prompt">您尚未登录<br><br><a href="login.html" class="button">去登录</a></div>';
        return;
      }
      content.innerHTML = '<p>加载中...</p>';
      const orders = await safeFetch(`api.php?action=my_orders&user_id=${user.id}`);
      renderOrders(orders);
    })();

    // Logout helper used by header
    function logout(){
      localStorage.removeItem('user');
      window.location.href = 'login.html';
    }
  </script>
</body>
</html>
