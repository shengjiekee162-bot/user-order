<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>é”€å”®è®°å½• - å–å®¶</title>
<style>
  :root{
    --bg:#040616; --panel:rgba(10,14,28,0.6); --muted:#9fb6d9; --accent:#00e6ff; --accent-2:#8a3bff; --glow: 0 8px 30px rgba(138,59,255,0.12);
  }
  body{font-family:Segoe UI,Roboto,Arial;margin:18px;background:linear-gradient(180deg,#05060a,#07101a);color:var(--muted)}
  .wrap{max-width:980px;margin:0 auto}
  header{display:flex;justify-content:space-between;align-items:center;margin-bottom:18px}
  h1{margin:0;color:var(--accent-2)}
  .card{background:linear-gradient(180deg,rgba(255,255,255,0.02),transparent);padding:14px;border-radius:10px;box-shadow:var(--glow);border:1px solid rgba(255,255,255,0.03);color:#e6f7ff}
  .order{margin-bottom:12px;padding:12px;border-radius:8px;border-left:4px solid var(--accent-2);background:linear-gradient(180deg,rgba(255,255,255,0.01),transparent)}
  table{width:100%;border-collapse:collapse}
  th,td{padding:8px 10px;border-top:1px solid rgba(255,255,255,0.03);text-align:left;color:#e6f7ff}
  th{background:rgba(255,255,255,0.02);color:var(--muted);font-weight:600}
  .muted{color:var(--muted)}
  a.btn{display:inline-block;padding:8px 12px;border-radius:8px;background:linear-gradient(90deg,var(--accent),var(--accent-2));color:#041226;text-decoration:none;box-shadow:0 8px 20px rgba(138,59,255,0.06)}
  @media (max-width:720px){ body{margin:12px} .order{padding:10px} th,td{padding:8px} }
</style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>ğŸ“ˆ é”€å”®è®°å½•</h1>
      <div>
        <a class="btn" href="seller.html">è¿”å›å–å®¶ä¸­å¿ƒ</a>
      </div>
    </header>

    <div id="content" class="card">
      <div id="loading" class="muted">æ­£åœ¨åŠ è½½é”€å”®è®°å½•â€¦â€¦</div>
      <div id="list"></div>
    </div>
  </div>

<script>
(async function(){
  const currentUser = JSON.parse(localStorage.getItem('user') || 'null');
  if(!currentUser){ alert('è¯·å…ˆç™»å½•'); window.location.href='login.html'; return; }
  if(currentUser.role !== 'seller'){ alert('ä»…é™å–å®¶æŸ¥çœ‹'); window.location.href='index.html'; return; }

  const listEl = document.getElementById('list');
  const loading = document.getElementById('loading');
  function escapeHtml(str){ if(!str) return ''; return String(str).replace(/[&<>'"]/g, s=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[s])); }

  try{
    const res = await fetch(`api.php?action=seller_sales&seller_id=${currentUser.id}`);
    const data = await res.json();
    loading.style.display = 'none';
    if(!Array.isArray(data) || data.length===0){ listEl.innerHTML = '<p class="muted">æš‚æ— é”€å”®è®°å½•ã€‚</p>'; return; }

    // Group by order_id
    const groups = {};
    data.forEach(r=>{
      const oid = r.order_id;
      if(!groups[oid]) groups[oid] = {order: r.order_id, date: r.order_date, buyer: r.buyer_username, payment_status: r.payment_status, payment_method: r.payment_method, items: []};
      groups[oid].items.push(r);
    });

    let html = '';
    Object.values(groups).forEach(g=>{
      html += `<div class="order">`;
      html += `<div style="font-weight:700;color:#f53d2d">è®¢å• #${escapeHtml(g.order)} â€” ä¹°å®¶: ${escapeHtml(g.buyer||'æœªçŸ¥')} â€” ${escapeHtml(g.date||'')}</div>`;
      html += `<div style="margin:8px 0">æ”¯ä»˜: ${escapeHtml(g.payment_method||'')} / ${escapeHtml(g.payment_status||'')}</div>`;
      html += `<table><thead><tr><th>å•†å“</th><th>å•ä»·</th><th>æ•°é‡</th><th>å°è®¡</th></tr></thead><tbody>`;
      g.items.forEach(it=>{
        const subtotal = (parseFloat(it.product_price) * parseInt(it.quantity||0)).toFixed(2);
        html += `<tr><td>${escapeHtml(it.product_name)}</td><td>RM ${parseFloat(it.product_price).toFixed(2)}</td><td>${escapeHtml(it.quantity)}</td><td>RM ${subtotal}</td></tr>`;
      });
      html += `</tbody></table>`;
      html += `</div>`;
    });

    listEl.innerHTML = html;
  }catch(err){
    loading.style.display = 'none';
    listEl.innerHTML = `<p class="muted">åŠ è½½å¤±è´¥ï¼š${escapeHtml(err.message || String(err))}</p>`;
  }
})();
</script>
</body>
</html>
