<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<title>å–å®¶ä¸­å¿ƒ - äº§å“ç®¡ç†</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
:root{
  --bg:#040616; --panel:rgba(10,14,28,0.6); --muted:#9fb6d9; --accent:#00e6ff; --accent-2:#8a3bff; --glow: 0 8px 30px rgba(138,59,255,0.12), 0 4px 16px rgba(0,230,255,0.06);
}
*{box-sizing:border-box}
body{font-family:Inter,Segoe UI,Roboto,Arial;background:linear-gradient(180deg,#05060a,#07101a);color:var(--muted);margin:0;padding:0}
.container{max-width:1200px;margin:0 auto;padding:20px}
.header{background:linear-gradient(90deg, rgba(138,59,255,0.12), rgba(0,230,255,0.08));color:#e8f7ff;padding:14px 20px;border-radius:10px;box-shadow:var(--glow);display:flex;justify-content:space-between;align-items:center}
.header h1{margin:0;color:#fff}
.main-content{display:flex;gap:20px;margin-top:18px}
.sidebar{width:320px}
.form-card{background:linear-gradient(180deg,rgba(255,255,255,0.02),transparent);padding:20px;border-radius:12px;box-shadow:var(--glow);border:1px solid rgba(255,255,255,0.03)}
.form-card h2{margin-top:0;color:var(--accent);font-size:18px;text-shadow:0 2px 10px rgba(0,230,255,0.06)}
.form-group{margin-bottom:14px}
.form-group label{display:block;margin-bottom:6px;color:var(--muted)}
.form-group input,.form-group select,.form-group textarea{width:100%;padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:#e6f7ff}
.btn-group{display:flex;gap:10px}
.btn{flex:1;padding:12px;border-radius:8px;border:none;cursor:pointer}
.btn-primary{background:linear-gradient(90deg,var(--accent),var(--accent-2));color:#041226;font-weight:800;box-shadow:0 12px 30px rgba(0,230,255,0.08)}
.btn-secondary{background:#0f1724;color:var(--muted);border:1px solid rgba(255,255,255,0.02)}
.products-card{flex:1;padding:18px;border-radius:12px;background:linear-gradient(180deg,rgba(255,255,255,0.02),transparent);box-shadow:0 8px 30px rgba(0,0,0,0.6);border:1px solid rgba(255,255,255,0.03)}
.product-item{display:flex;gap:12px;align-items:center;padding:12px;border-radius:10px;border:1px solid rgba(255,255,255,0.03);margin-bottom:12px;background:linear-gradient(180deg,rgba(255,255,255,0.01),transparent)}
.product-item img{width:140px;height:90px;object-fit:cover;border-radius:8px;box-shadow:0 8px 24px rgba(0,0,0,0.6)}
.product-info h3{margin:0;color:#e8f7ff;text-shadow:0 1px 8px rgba(138,59,255,0.04)}
.product-info p{margin:6px 0;color:var(--muted)}
.product-price{color:var(--accent);font-weight:800}
.product-actions button{padding:8px 10px;border-radius:8px;border:none;cursor:pointer}
.btn-edit{background:#10b981;color:#041226}
.btn-delete{background:#ef4444;color:#fff}
.empty-state{padding:40px;text-align:center;color:#9aa4bf}
/* Sales records styling (uses site theme variables) */
.sale-card{background:linear-gradient(180deg, rgba(255,255,255,0.02), transparent); padding:14px; border-radius:10px; margin-bottom:12px; border:1px solid rgba(255,255,255,0.03); color:#e6f7ff}
.sale-header{font-weight:700; color:var(--accent-2); margin-bottom:6px}
.sale-meta{color:var(--muted); margin-top:6px}
.sale-table{width:100%; margin-top:10px; border-collapse:collapse}
.sale-table th{text-align:left; padding:10px; background:rgba(255,255,255,0.02); color:var(--muted); font-weight:600}
.sale-table td{padding:10px; border-top:1px solid rgba(255,255,255,0.03); color:#e6f7ff}
.sale-empty{color:var(--muted)}
@media (max-width:900px){.main-content{flex-direction:column}.sidebar{width:100%}}
</style>
</head>
<body>

<header>
  <h1 data-i18n="seller.title">ğŸª å–å®¶ä¸­å¿ƒ</h1>
  <div class="user-info">
    <span id="userDisplay">æœªç™»å½•</span>
    <button onclick="logout()">é€€å‡ºç™»å½•</button>
  </div>
</header>

<div class="container">
  <div class="main-content">
    <!-- å·¦ä¾§è¾¹æ  - æ·»åŠ äº§å“è¡¨å• -->
    <div class="sidebar">
      <div class="stats">
        <div class="stat-card">
          <div class="stat-label">å•†å“æ€»æ•°</div>
          <div class="stat-value" id="totalProducts">0</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">æ€»é”€å”®é¢</div>
          <div class="stat-value" id="totalSales">RM 0</div>
        </div>
      </div>

      <div class="form-card">
        <h2 id="formTitle" data-i18n="seller.add">â• æ·»åŠ å•†å“</h2>
        
        <div id="alert" class="alert"></div>

        <div class="form-group">
          <label for="productName">å•†å“åç§° *</label>
          <input type="text" id="productName" placeholder="è¾“å…¥å•†å“åç§°" required>
        </div>

        <div class="form-group">
          <label for="productPrice">ä»·æ ¼ (RM) *</label>
          <input type="number" id="productPrice" placeholder="è¾“å…¥ä»·æ ¼" step="0.01" min="0" required>
        </div>

        <div class="form-group">
          <label for="productCategory">åˆ†ç±» *ï¼ˆå¯è‡ªå®šä¹‰ï¼‰</label>
          <input type="text" id="productCategory" list="categoriesList" placeholder="è¾“å…¥åˆ†ç±»åç§°ï¼Œä¾‹å¦‚ï¼šç”µå­äº§å“" required>
          <datalist id="categoriesList"></datalist>
        </div>

        <div class="form-group">
          <label for="productDesc">å•†å“æè¿°</label>
          <textarea id="productDesc" placeholder="è¾“å…¥å•†å“æè¿°ï¼ˆå¯é€‰ï¼‰"></textarea>
        </div>

        <div class="form-group">
          <label for="productImage">å•†å“å›¾ç‰‡ / è§†é¢‘ï¼ˆå¯é€‰ï¼Œå¤šé€‰ï¼‰</label>
          <input type="file" id="productImage" accept="image/*,video/*" multiple>
          <div id="imagePreview" style="margin-top:8px; display:flex; gap:8px; flex-wrap:wrap"></div>
        </div>

        <div class="btn-group">
          <button class="btn btn-primary" onclick="addOrUpdateProduct()" id="submitBtn" data-i18n="seller.add">æ·»åŠ å•†å“</button>
          <button class="btn btn-secondary" onclick="cancelEdit()" id="cancelBtn" style="display:none;" data-i18n="seller.delete">å–æ¶ˆç¼–è¾‘</button>
        </div>
      </div>

      <div class="nav-links">
        <a href="index.html">ğŸ  è¿”å›é¦–é¡µ</a>
        <a href="orders.html">ğŸ“¦ æŸ¥çœ‹è®¢å•</a>
        <a href="seller_sales.html">ğŸ“ˆ é”€å”®è®°å½•</a>
      </div>
    </div>

    <!-- å³ä¾§ä¸»å†…å®¹ - å•†å“åˆ—è¡¨ -->
    <div class="content">
      <div class="products-card">
        <h2 data-i18n="seller.title">ğŸ“¦ æˆ‘çš„å•†å“</h2>
        <div style="margin-bottom:12px; text-align:right;">
          <!-- Bulk claim removed: single-item claim remains -->
        </div>
        <div id="productsList"></div>
        
        <hr style="margin:18px 0;" />

        <h2>ğŸ“ˆ é”€å”®è®°å½•</h2>
        <div style="margin-bottom:12px; text-align:right;">
          <button class="btn btn-secondary" onclick="loadSellerSales()">åˆ·æ–°é”€å”®è®°å½•</button>
          <button class="btn btn-secondary" onclick="loadSellerProductStats()">æŸ¥çœ‹å•†å“é”€å”®æ±‡æ€»</button>
        </div>
        <div id="salesArea">
          <p style="color:#999;">å°šæœªåŠ è½½é”€å”®è®°å½•ï¼Œç‚¹å‡»â€œåˆ·æ–°é”€å”®è®°å½•â€ä»¥æŸ¥çœ‹ã€‚</p>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
let currentUser = JSON.parse(localStorage.getItem("user")) || null;
let editingProductId = null;
let allProducts = [];

// æ£€æŸ¥ç”¨æˆ·ç™»å½•çŠ¶æ€
function checkLogin() {
  if (!currentUser) {
    alert('è¯·å…ˆç™»å½•å–å®¶è´¦å·');
    window.location.href = 'login.html';
    return false;
  }
  if (currentUser.role !== 'seller') {
    alert('æ­¤é¡µé¢ä»…é™å–å®¶è®¿é—®');
    window.location.href = 'index.html';
    return false;
  }
  return true;
}

// æ˜¾ç¤ºç”¨æˆ·ä¿¡æ¯
function showUser() {
  const userDiv = document.getElementById('userDisplay');
  if (currentUser) {
    userDiv.innerHTML = `æ¬¢è¿å›æ¥ï¼Œ<b>${currentUser.username}</b>`;
  }
}

// é€€å‡ºç™»å½•
function logout() {
  localStorage.removeItem("user");
  window.location.href = 'login.html';
}

// å®‰å…¨çš„ç½‘ç»œè¯·æ±‚
async function safeFetch(url, options) {
  try {
    const res = await fetch(url, options);
    const text = await res.text();
    
    try {
      return JSON.parse(text);
    } catch {
      console.error("è¿”å›éJSON:", text);
      return null;
    }
  } catch (err) {
    console.error("ç½‘ç»œè¯·æ±‚å¤±è´¥:", err.message);
    showAlert('ç½‘ç»œè¯·æ±‚å¤±è´¥: ' + err.message, 'error');
    return null;
  }
}

// æ˜¾ç¤ºæç¤ºä¿¡æ¯
function showAlert(message, type = 'success') {
  const alert = document.getElementById('alert');
  alert.textContent = message;
  alert.className = 'alert ' + type;
  if (type === 'success') {
    setTimeout(() => {
      alert.style.display = 'none';
    }, 3000);
  }
}

// åŠ è½½å–å®¶é”€å”®æ˜ç»†ï¼ˆç‹¬ç«‹å‡½æ•°ï¼Œä¾›æŒ‰é’®æˆ–å…¶å®ƒè§¦å‘ï¼‰
async function loadSellerSales(){
  if (!currentUser) return;
  const area = document.getElementById('salesArea');
  area.innerHTML = '<p>åŠ è½½ä¸­...</p>';
  const res = await safeFetch(`api.php?action=seller_sales&seller_id=${currentUser.id}`);
  if (!res) { area.innerHTML = '<p style="color:#999;">åŠ è½½å¤±è´¥</p>'; return; }
  if (!Array.isArray(res) || res.length === 0) {
    area.innerHTML = '<p style="color:#999;">æš‚æ— é”€å”®è®°å½•</p>';
    return;
  }
  // render list grouped by order_id
  const groups = {};
  res.forEach(r=>{
    const oid = r.order_id;
    if(!groups[oid]) groups[oid] = {order: r.order_id, date: r.order_date, buyer: r.buyer_username, payment_status: r.payment_status, payment_method: r.payment_method, items: []};
    groups[oid].items.push(r);
  });
  let html = '';
  Object.values(groups).forEach(g=>{
    html += `<div class="sale-card">
      <div class="sale-header">è®¢å• #${g.order} â€” ä¹°å®¶: ${escapeHtml(g.buyer||'æœªçŸ¥')} â€” ${g.date}</div>
      <div class="sale-meta">æ”¯ä»˜: ${escapeHtml(g.payment_method||'')} / ${escapeHtml(g.payment_status||'')}</div>
      <table class="sale-table"><tr><th>å•†å“</th><th>å•ä»·</th><th>æ•°é‡</th><th>å°è®¡</th></tr>`;
    g.items.forEach(it=>{
      const subtotal = (parseFloat(it.product_price) * parseInt(it.quantity)).toFixed(2);
      html += `<tr><td>${escapeHtml(it.product_name)}</td><td>RM ${parseFloat(it.product_price).toFixed(2)}</td><td>${it.quantity}</td><td>RM ${subtotal}</td></tr>`;
    });
    html += `</table></div>`;
  });
  area.innerHTML = html;
}

// åŠ è½½å–å®¶æ¯ä¸ªå•†å“çš„é”€å”®æ±‡æ€»ï¼ˆç‹¬ç«‹å‡½æ•°ï¼‰
async function loadSellerProductStats(){
  if (!currentUser) return;
  const area = document.getElementById('salesArea');
  area.innerHTML = '<p>åŠ è½½ä¸­...</p>';
  const res = await safeFetch(`api.php?action=seller_product_stats&seller_id=${currentUser.id}`);
  if (!res) { area.innerHTML = '<p style="color:#999;">åŠ è½½å¤±è´¥</p>'; return; }
  if (!Array.isArray(res) || res.length === 0) {
    area.innerHTML = '<p style="color:#999;">æš‚æ— é”€å”®ç»Ÿè®¡</p>';
    return;
  }
  let html = `<table class="sale-table"><tr><th>å•†å“</th><th>å·²å”®æ•°é‡</th><th>æ€»æ”¶å…¥ (RM)</th></tr>`;
  res.forEach(r=>{
    html += `<tr><td>${escapeHtml(r.product_name)}</td><td>${r.total_sold}</td><td>RM ${parseFloat(r.total_revenue).toFixed(2)}</td></tr>`;
  });
  html += '</table>';
  area.innerHTML = html;
}

// è½¬ä¹‰HTML
function escapeHtml(str) {
  if (!str) return '';
  return String(str).replace(/[&<>"']/g, function(s) {
    return {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[s];
  });
}

// åŠ è½½å–å®¶çš„å•†å“åˆ—è¡¨
async function loadMyProducts() {
  if (!currentUser) return;
  
  const data = await safeFetch(`api.php?action=my_products&seller_id=${currentUser.id}`);
  if (!data) {
    document.getElementById('productsList').innerHTML = '<p style="text-align:center; color:#999;">åŠ è½½å¤±è´¥</p>';
    return;
  }

  allProducts = Array.isArray(data) ? data : [];
  
  const container = document.getElementById('productsList');
  
  if (allProducts.length === 0) {
    container.innerHTML = `
      <div class="empty-state">
        <div>ğŸ“­</div>
        <p>æš‚æ— å•†å“ï¼Œå»æ·»åŠ æ‚¨çš„ç¬¬ä¸€ä¸ªå•†å“å§ï¼</p>
      </div>
    `;
  } else {
    // ä½¿ç”¨ renderProductHTML ç”Ÿæˆæ¯ä¸ªæ¡ç›®ï¼Œä¾¿äºåç»­å±€éƒ¨æ›¿æ¢
    container.innerHTML = allProducts.map(p => renderProductHTML(p)).join('');
    if(window.__i18n && typeof window.__i18n.apply === 'function') window.__i18n.apply();
  }
  
  // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
  document.getElementById('totalProducts').textContent = allProducts.length;
}

// å¼€å§‹ç¼–è¾‘å•†å“
async function editProduct(productId) {
  const product = await safeFetch(`api.php?action=get_product&id=${productId}`);
  if (!product) return;
  
  editingProductId = productId;
  document.getElementById('productName').value = product.name || '';
  document.getElementById('productPrice').value = product.price || '';
  document.getElementById('productCategory').value = product.category_name || '';
  document.getElementById('productDesc').value = product.description || '';
  
  // æ›´æ”¹æŒ‰é’®çŠ¶æ€
  document.getElementById('formTitle').textContent = 'âœï¸ ç¼–è¾‘å•†å“';
  document.getElementById('submitBtn').textContent = 'ä¿å­˜ä¿®æ”¹';
  document.getElementById('cancelBtn').style.display = 'block';
  
  // æ»šåŠ¨åˆ°è¡¨å•
  document.querySelector('.form-card').scrollIntoView({ behavior: 'smooth' });
  // If product has media, show preview placeholders (support JSON array and YouTube)
  const imgPreview = document.getElementById('imagePreview');
  const imgInput = document.getElementById('productImage');
  if (imgPreview) {
    imgPreview.innerHTML = '';
    if (product.image) {
      try {
        let imgs = product.image;
        if (typeof imgs === 'string' && imgs.trim().startsWith('[')) imgs = JSON.parse(imgs);
        if (!Array.isArray(imgs)) imgs = [imgs];
        const existingYt = [];
        imgs.forEach(src => {
          if (!src) return;
          const s = String(src).replace(/\r?\n/g,'').trim();
          const id = extractYtId(s);
          if (id) {
            existingYt.push(s);
            imgPreview.insertAdjacentHTML('beforeend', `<iframe src="https://www.youtube.com/embed/${id}" style="max-width:220px;max-height:140px;border:0;margin-right:8px" frameborder="0" allowfullscreen></iframe>`);
            } else {
              const lower = s.toLowerCase();
              if (lower.match(/\.(mp4|webm|ogg|mov)$/) || s.indexOf('uploads/') === 0) {
                imgPreview.insertAdjacentHTML('beforeend', `<div style="position:relative;display:inline-block;margin-right:8px"><video src="${escapeHtml(s)}" style="max-width:140px;max-height:90px;border-radius:6px;display:block" controls></video><button onclick="removeUploadedMedia(${product.id}, '${encodeURIComponent(s)}')" style="position:absolute;top:4px;right:4px;background:rgba(0,0,0,0.6);color:#fff;border:none;border-radius:12px;width:24px;height:24px;cursor:pointer">âœ–</button></div>`);
              } else {
                imgPreview.insertAdjacentHTML('beforeend', `<div style="position:relative;display:inline-block;margin-right:8px"><img src="${escapeHtml(s)}" style="max-width:140px;max-height:90px;border-radius:6px;display:block"><button onclick="removeUploadedMedia(${product.id}, '${encodeURIComponent(s)}')" style="position:absolute;top:4px;right:4px;background:rgba(0,0,0,0.6);color:#fff;border:none;border-radius:12px;width:24px;height:24px;cursor:pointer">âœ–</button></div>`);
              }
          }
        });
        if (existingYt.length > 0) {
          const ytInputEl = document.getElementById('youtubeLinks');
          const prev = (ytInputEl.value || '').trim();
          const merged = prev ? (prev + '\n' + existingYt.join('\n')) : existingYt.join('\n');
          ytInputEl.value = merged;
          ytInputEl.dispatchEvent(new Event('input'));
        }
      } catch(e){ /* ignore parse errors */ }
    }
  }
  if (imgInput) imgInput.value = '';
}

// å–æ¶ˆç¼–è¾‘
function cancelEdit() {
  editingProductId = null;
  document.getElementById('productName').value = '';
  document.getElementById('productPrice').value = '';
  document.getElementById('productCategory').value = '';
  document.getElementById('productDesc').value = '';
  const img = document.getElementById('productImage'); if(img) img.value = '';
  
  document.getElementById('formTitle').textContent = 'â• æ·»åŠ å•†å“';
  document.getElementById('submitBtn').textContent = 'æ·»åŠ å•†å“';
  document.getElementById('cancelBtn').style.display = 'none';
  
  document.getElementById('alert').style.display = 'none';
}

// æ·»åŠ æˆ–æ›´æ–°å•†å“
async function addOrUpdateProduct() {
  const name = document.getElementById('productName').value.trim();
  const price = parseFloat(document.getElementById('productPrice').value);
  const category = document.getElementById('productCategory').value.trim();
  const description = document.getElementById('productDesc').value.trim();

  if (!name || !price || !category) {
    showAlert('è¯·å¡«å†™å¿…å¡«é¡¹ï¼šå•†å“åç§°ã€ä»·æ ¼ã€åˆ†ç±»', 'error');
    return;
  }

  if (price <= 0) {
    showAlert('ä»·æ ¼å¿…é¡»å¤§äº0', 'error');
    return;
  }

  const action = editingProductId ? "update_product" : "add_product";
  const productData = {
    action,
    name,
    price,
    category, // send category name; backend will map to id
    seller_id: currentUser.id,
    description
  };

  // If image/video files are selected, upload them first to get paths (support multiple)
  const fileInput = document.getElementById('productImage');
  let collectedPaths = [];
  if (fileInput && fileInput.files && fileInput.files.length > 0) {
    try {
      const fd = new FormData();
      Array.from(fileInput.files).forEach(f => fd.append('files[]', f));
      const upRes = await fetch('upload.php', { method: 'POST', body: fd });
      const upJson = await upRes.json();
      if (upJson && upJson.status === 'ok' && (upJson.paths || upJson.path)) {
        const paths = upJson.paths ? upJson.paths : [upJson.path];
        collectedPaths = collectedPaths.concat(paths);
      } else {
        showAlert((upJson && upJson.message) ? 'åª’ä½“æ–‡ä»¶ä¸Šä¼ å¤±è´¥ï¼š' + upJson.message : 'åª’ä½“æ–‡ä»¶ä¸Šä¼ å¤±è´¥', 'error');
        return;
      }
    } catch (e) {
      showAlert('åª’ä½“æ–‡ä»¶ä¸Šä¼ å¤±è´¥ï¼š' + e.message, 'error');
      return;
    }
  }

  // collect YouTube links (split by newline or comma)
  const ytInput = document.getElementById('youtubeLinks');
  if (ytInput && ytInput.value.trim()){
    const raw = ytInput.value.trim();
    const parts = raw.split(/[,\n]+/).map(s=>s.trim()).filter(Boolean);
    parts.forEach(u=>{ const id = extractYtId(u); if(id) collectedPaths.push(u); });
  }

  // if we have any collected media (uploads or youtube links), store as JSON string
  if(collectedPaths.length > 0){
    productData.image = JSON.stringify(collectedPaths);
  }

  if (editingProductId) {
    productData.id = editingProductId;
  }
  const submitBtn = document.getElementById('submitBtn');
  const origText = submitBtn.innerHTML;
  submitBtn.disabled = true;
  submitBtn.innerHTML = editingProductId ? 'ä¿å­˜ä¸­...' : 'æ·»åŠ ä¸­...';

  const msg = await safeFetch("api.php", {
    method: "POST",
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify(productData)
  });

  submitBtn.disabled = false;
  submitBtn.innerHTML = origText;

  if (!msg) return;

  if (msg.status === "ok") {
    showAlert(editingProductId ? 'âœ“ å•†å“å·²æ›´æ–°' : 'âœ“ å•†å“å·²æ·»åŠ ', 'success');
    // è·å–æœ€æ–°å•†å“å¹¶å±€éƒ¨æ›¿æ¢/æ’å…¥
    const idToFetch = msg.product_id ? msg.product_id : (productData.id || editingProductId);
    if (idToFetch) {
      const prod = await safeFetch(`api.php?action=get_product&id=${idToFetch}`);
      if (prod && prod.id) replaceOrInsertProduct(prod);
    } else {
      await loadMyProducts();
    }
    // refresh local category suggestions and notify other tabs
    try{ loadCategoryOptions(); }catch(e){}
    try{ localStorage.setItem('categoriesUpdated', Date.now()); }catch(e){}
    cancelEdit();
  } else {
    showAlert(msg.message || 'æ“ä½œå¤±è´¥', 'error');
  }
}

// åˆ é™¤å•†å“
async function deleteProduct(productId) {
  if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªå•†å“å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ã€‚')) return;
  const btnId = `btn-delete-${productId}`;
  setButtonLoading(btnId, true, 'åˆ é™¤ä¸­...');
  const msg = await safeFetch("api.php", {
    method: "POST",
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify({ action: "delete_product", id: productId, seller_id: currentUser.id })
  });
  setButtonLoading(btnId, false);
  if (!msg) return;
  if (msg.status === "ok") {
    showAlert('âœ“ å•†å“å·²åˆ é™¤', 'success');
    const el = document.getElementById(`prod-${productId}`);
    if (el) el.remove();
    updateTotalCount();
    // åˆ·æ–°ç»Ÿè®¡
    loadSellerStats();
  } else {
    showAlert(msg.message || 'åˆ é™¤å¤±è´¥', 'error');
  }
}

// è®¤é¢†å•†å“ï¼ˆå°† seller_id è®¾ä¸ºå½“å‰å–å®¶ï¼‰
async function claimProduct(productId) {
  if (!confirm('ç¡®å®šè¦è®¤é¢†æ­¤å•†å“å¹¶å°†å…¶å½’å±ä¸ºæ‚¨çš„å•†å“å—ï¼Ÿ')) return;
  const btnId = `btn-claim-${productId}`;
  setButtonLoading(btnId, true, 'è®¤é¢†ä¸­...');
  const msg = await safeFetch("api.php", {
    method: "POST",
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify({ action: 'claim_product', id: productId, seller_id: currentUser.id })
  });
  setButtonLoading(btnId, false);
  if (!msg) return;
  if (msg.status === 'ok') {
    showAlert('âœ“ å•†å“å·²è®¤é¢†', 'success');
    const prod = await safeFetch(`api.php?action=get_product&id=${productId}`);
    if (prod && prod.id) replaceOrInsertProduct(prod);
  } else {
    showAlert(msg.message || 'è®¤é¢†å¤±è´¥', 'error');
  }
}

// å¼ºåˆ¶è®¤é¢†ï¼ˆè¦†ç›–åŸæœ‰ seller_idï¼Œæ“ä½œä¸å¯é€†ï¼Œéœ€è°¨æ…ï¼‰
async function forceClaimProduct(productId) {
  if (!confirm('å¼ºåˆ¶è®¤é¢†ä¼šæŠŠå•†å“çš„åŸæœ‰å½’å±è¦†ç›–ã€‚è¯·ç¡®è®¤æ‚¨æœ‰æƒé™å¹¶æ„¿æ„æ‰¿æ‹…åæœã€‚ç»§ç»­å—ï¼Ÿ')) return;
  const btnId = `btn-force-${productId}`;
  setButtonLoading(btnId, true, 'å¤„ç†ä¸­...');
  const msg = await safeFetch("api.php", {
    method: "POST",
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify({ action: 'force_claim_product', id: productId, seller_id: currentUser.id })
  });
  setButtonLoading(btnId, false);
  if (!msg) return;
  if (msg.status === 'ok') {
    // optional: show old/new owner info if returned by backend
    if (msg.old_owner) {
      showAlert(`âœ“ å·²å¼ºåˆ¶è®¤é¢†ï¼ˆåŸå½’å±: ${msg.old_owner} -> æ–°å½’å±: ${msg.new_owner || currentUser.id}ï¼‰`, 'success');
    } else {
      showAlert('âœ“ å·²å¼ºåˆ¶è®¤é¢†', 'success');
    }
    const prod = await safeFetch(`api.php?action=get_product&id=${productId}`);
    if (prod && prod.id) replaceOrInsertProduct(prod);
  } else {
    showAlert(msg.message || 'å¼ºåˆ¶è®¤é¢†å¤±è´¥', 'error');
  }
}

// Bulk claim removed by request. Use single-item 'è®¤é¢†å•†å“' (claimProduct) or 'å¼ºåˆ¶è®¤é¢†' for specific items.

// é¡µé¢åˆå§‹åŒ–
document.addEventListener('DOMContentLoaded', function() {
  if (!checkLogin()) return;
  showUser();
  // åŠ è½½å•†å“å¹¶åˆ·æ–°ç»Ÿè®¡ä¿¡æ¯
  loadMyProducts().then(() => {
    loadSellerStats();
  });
  // load category suggestions for the category input
  loadCategoryOptions();
  // image/video input preview (support multiple files)
  const imgInput = document.getElementById('productImage');
  if (imgInput) {
    imgInput.addEventListener('change', function(e){
      const p = document.getElementById('imagePreview');
      p.innerHTML = '';
      const files = Array.from(this.files || []);
      if (files.length === 0) return;
      files.forEach(f => {
        const url = URL.createObjectURL(f);
        if (f.type.startsWith('image/')) {
          const img = document.createElement('img');
          img.src = url;
          img.style.maxWidth = '140px';
          img.style.maxHeight = '90px';
          img.style.borderRadius = '6px';
          img.style.display = 'block';
          p.appendChild(img);
        } else if (f.type.startsWith('video/')) {
          const vid = document.createElement('video');
          vid.src = url;
          vid.style.maxWidth = '140px';
          vid.style.maxHeight = '90px';
          vid.controls = true;
          p.appendChild(vid);
        }
      });
    });
  }
});

// åŠ è½½å–å®¶ç»Ÿè®¡ï¼ˆå•†å“æ€»æ•°ã€æ€»é”€å”®é¢ï¼‰
async function loadSellerStats(){
  if (!currentUser) return;
  const res = await safeFetch(`api.php?action=seller_stats&seller_id=${currentUser.id}`);
  if (!res) return;
  const total = parseInt(res.total_products) || 0;
  const sales = parseFloat(res.total_sales) || 0;
  document.getElementById('totalProducts').textContent = total;
  document.getElementById('totalSales').textContent = `RM ${sales.toFixed(2)}`;
}

// Load category options into the datalist and dedupe names
async function loadCategoryOptions(){
  const listEl = document.getElementById('categoriesList');
  if(!listEl) return;
  try{
    const data = await safeFetch('api.php?action=list_categories');
    if(!Array.isArray(data)) return;
    const seen = new Set();
    listEl.innerHTML = '';
    data.forEach(c => {
      const name = (c && c.name) ? String(c.name).trim() : '';
      if(!name) return;
      const key = name.toLowerCase();
      if(seen.has(key)) return; // dedupe case-insensitively
      seen.add(key);
      const opt = document.createElement('option');
      opt.value = name;
      listEl.appendChild(opt);
    });
  }catch(e){ console.warn('åŠ è½½åˆ†ç±»å»ºè®®å¤±è´¥', e); }
}

// Refresh category suggestions when other tabs update categories
window.addEventListener('storage', function(e){
  if(e.key === 'categoriesUpdated') loadCategoryOptions();
});

// Remove an uploaded media file from a product (frontend handler)
async function removeUploadedMedia(productId, mediaEncoded){
  const media = decodeURIComponent(mediaEncoded);
  if(!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªåª’ä½“å—ï¼Ÿ')) return;
  const res = await safeFetch('api.php', {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify({ action: 'remove_media', id: productId, seller_id: currentUser.id, media })
  });
  if(!res) return;
  if(res.status === 'ok'){
    // remove matching preview elements
    document.querySelectorAll('#imagePreview > div, #imagePreview img, #imagePreview video, #imagePreview iframe').forEach(el=>{
      try{
        const nested = el.tagName === 'DIV' ? (el.querySelector('img,video,iframe')) : el;
        const src = nested && nested.src ? nested.src : '';
        if(src && src.indexOf(media) !== -1){
          el.remove();
        }
      }catch(e){}
    });
    // also remove from youtube textarea if present
    const ytEl = document.getElementById('youtubeLinks');
    if(ytEl){
      const parts = (ytEl.value||'').split(/[,\n]+/).map(s=>s.trim()).filter(Boolean);
      const filtered = parts.filter(p=> p !== media);
      if(filtered.length !== parts.length){ ytEl.value = filtered.join('\n'); ytEl.dispatchEvent(new Event('input')); }
    }
    // refresh product in list
    const prod = await safeFetch(`api.php?action=get_product&id=${productId}`);
    if(prod && prod.id) replaceOrInsertProduct(prod);
    showAlert('åª’ä½“å·²åˆ é™¤', 'success');
  } else {
    showAlert(res.message || 'åˆ é™¤åª’ä½“å¤±è´¥', 'error');
  }
}

// Helper: æ¸²æŸ“å•ä¸ªå•†å“ä¸º HTMLï¼ˆå¸¦å”¯ä¸€ idï¼Œä¾¿äºå±€éƒ¨æ›¿æ¢ï¼‰
function renderProductHTML(p) {
  const ownerNum = parseInt(p.seller_id) || 0;
  const me = parseInt(currentUser.id) || 0;
  let actions = '';
  if (ownerNum === me) {
    actions = `
      <button id="btn-edit-${p.id}" class="btn-edit" onclick="editProduct(${p.id})" data-i18n="seller.edit">âœï¸ ç¼–è¾‘</button>
      <button id="btn-delete-${p.id}" class="btn-delete" onclick="deleteProduct(${p.id})" data-i18n="seller.delete">ğŸ—‘ï¸ åˆ é™¤</button>
    `;
  } else if (ownerNum === 0) {
    actions = `<button id="btn-claim-${p.id}" class="btn-primary" onclick="claimProduct(${p.id})">ğŸ”– è®¤é¢†å•†å“</button>`;
  } else {
    // å•†å“å±äºå…¶ä»–å–å®¶ï¼šæ˜¾ç¤ºå½’å±å¹¶æä¾›å¼ºåˆ¶è®¤é¢†ï¼ˆè°¨æ…æ“ä½œï¼‰
    actions = `
      <span style="color:#999; font-size:13px; margin-right:8px;">å½’å±å–å®¶: ${ownerNum}</span>
      <button id="btn-force-${p.id}" class="btn-secondary" onclick="forceClaimProduct(${p.id})">âš ï¸ å¼ºåˆ¶è®¤é¢†</button>
    `;
  }

  // thumbnail HTML (support JSON-array stored in p.image)
  let imgHtml = '';
  try {
    if (p.image) {
      let imgs = p.image;
      if (typeof imgs === 'string' && imgs.trim().startsWith('[')) imgs = JSON.parse(imgs);
      if (!Array.isArray(imgs)) imgs = [imgs];
      if (Array.isArray(imgs) && imgs.length > 0) {
        imgHtml = `<div style="margin-right:12px;"><img src="${escapeHtml(String(imgs[0]).replace(/\r?\n/g,''))}" style="width:140px;height:90px;object-fit:cover;border-radius:6px;display:block"></div>`;
      }
    }
  } catch(e){ imgHtml = ''; }

  return `
  <div class="product-item" id="prod-${p.id}">
    ${imgHtml}
    <div class="product-info">
      <h3>${escapeHtml(p.name)}</h3>
      <p>${escapeHtml(p.description || 'æš‚æ— æè¿°')}</p>
      <div class="product-price">RM ${parseFloat(p.price).toFixed(2)}</div>
      <div class="product-actions">
        ${actions}
      </div>
    </div>
  </div>
  `;
}

// Helper: ç”¨æ–°æ•°æ®æ›¿æ¢æˆ–æ’å…¥å•†å“å…ƒç´ 
function replaceOrInsertProduct(p) {
  const container = document.getElementById('productsList');
  const existing = document.getElementById(`prod-${p.id}`);
  const html = renderProductHTML(p);
  if (existing) {
    existing.outerHTML = html;
  } else {
    container.insertAdjacentHTML('afterbegin', html);
  }
  updateTotalCount();
  // åˆ·æ–°ç»Ÿè®¡ï¼ˆåŒ…æ‹¬æ€»é”€å”®é¢ï¼‰
  loadSellerStats();
  if(window.__i18n && typeof window.__i18n.apply === 'function') window.__i18n.apply();
}

// æ›´æ–°ç»Ÿè®¡æ•°å­—ï¼ˆåŸºäº DOM å…ƒç´ æ•°ï¼‰
function updateTotalCount() {
  const count = document.querySelectorAll('#productsList .product-item').length;
  document.getElementById('totalProducts').textContent = count;
}

// è®¾ç½®æŒ‰é’®åŠ è½½çŠ¶æ€
function setButtonLoading(btnId, loading, text) {
  const btn = document.getElementById(btnId);
  if (!btn) return;
  if (loading) {
    btn.disabled = true;
    btn.dataset.orig = btn.innerHTML;
    btn.innerHTML = text;
  } else {
    btn.disabled = false;
    if (btn.dataset.orig) btn.innerHTML = btn.dataset.orig;
  }
}
</script>

<script src="i18n.js"></script>

</body>
</html>