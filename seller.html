<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<title>å–å®¶ä¸­å¿ƒ - äº§å“ç®¡ç†</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
body { 
  font-family: 'Segoe UI', Arial, sans-serif; 
  background: #f5f5f5; 
  margin: 0; 
  padding: 0;
}

.container {
  max-width: 1200px;
  margin: 0 auto;
  padding: 20px;
}

header {
  background: #f53d2d;
  color: white;
  padding: 15px 20px;
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 20px;
  border-radius: 8px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

header h1 {
  margin: 0;
  font-size: 24px;
}

header .user-info {
  display: flex;
  align-items: center;
  gap: 10px;
}

header .user-info button {
  background: white;
  color: #f53d2d;
  border: none;
  padding: 8px 12px;
  border-radius: 4px;
  cursor: pointer;
  font-weight: bold;
}

header .user-info button:hover {
  background: #fce4e0;
}

.main-content {
  display: flex;
  gap: 20px;
}

.sidebar {
  width: 300px;
}

.form-card {
  background: white;
  padding: 20px;
  border-radius: 8px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.1);
  margin-bottom: 20px;
}

.form-card h2 {
  margin-top: 0;
  color: #f53d2d;
  font-size: 20px;
  border-bottom: 2px solid #f53d2d;
  padding-bottom: 10px;
}

.form-group {
  margin-bottom: 15px;
}

.form-group label {
  display: block;
  margin-bottom: 5px;
  font-weight: bold;
  color: #333;
}

.form-group input,
.form-group select,
.form-group textarea {
  width: 100%;
  padding: 10px;
  border: 1px solid #ddd;
  border-radius: 4px;
  font-family: inherit;
  box-sizing: border-box;
}

.form-group textarea {
  resize: vertical;
  min-height: 80px;
}

.form-group input:focus,
.form-group select:focus,
.form-group textarea:focus {
  outline: none;
  border-color: #f53d2d;
  box-shadow: 0 0 5px rgba(245, 61, 45, 0.3);
}

.btn-group {
  display: flex;
  gap: 10px;
}

.btn {
  flex: 1;
  padding: 12px;
  border: none;
  border-radius: 4px;
  font-size: 16px;
  font-weight: bold;
  cursor: pointer;
  transition: all 0.3s;
}

.btn-primary {
  background: #f53d2d;
  color: white;
}

.btn-primary:hover {
  background: #d42828;
}

.btn-secondary {
  background: #ddd;
  color: #333;
}

.btn-secondary:hover {
  background: #bbb;
}

.content {
  flex: 1;
}

.products-card {
  background: white;
  padding: 20px;
  border-radius: 8px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.products-card h2 {
  margin-top: 0;
  color: #f53d2d;
  font-size: 20px;
  border-bottom: 2px solid #f53d2d;
  padding-bottom: 10px;
  margin-bottom: 15px;
}

.product-item {
  background: #f9f9f9;
  padding: 15px;
  margin-bottom: 15px;
  border-radius: 6px;
  border-left: 4px solid #f53d2d;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.product-info {
  flex: 1;
}

.product-info h3 {
  margin: 0 0 5px 0;
  color: #333;
}

.product-info p {
  margin: 3px 0;
  color: #666;
  font-size: 14px;
}

.product-price {
  font-size: 18px;
  font-weight: bold;
  color: #f53d2d;
  margin: 5px 0;
}

.product-actions {
  display: flex;
  gap: 10px;
  margin-top: 10px;
}

.product-actions button {
  padding: 6px 12px;
  border: none;
  border-radius: 4px;
  cursor: pointer;
  font-size: 14px;
  transition: all 0.3s;
}

.btn-edit {
  background: #4CAF50;
  color: white;
}

.btn-edit:hover {
  background: #45a049;
}

.btn-delete {
  background: #f44336;
  color: white;
}

.btn-delete:hover {
  background: #da190b;
}

.empty-state {
  text-align: center;
  padding: 40px;
  color: #999;
}

.empty-state svg {
  width: 80px;
  height: 80px;
  margin-bottom: 15px;
}

/* å“åº”å¼è®¾è®¡ */
@media (max-width: 768px) {
  .main-content {
    flex-direction: column;
  }
  
  .sidebar {
    width: 100%;
  }
  
  .product-item {
    flex-direction: column;
    align-items: flex-start;
  }
  
  .product-actions {
    width: 100%;
  }
  
  .product-actions button {
    flex: 1;
  }
}

.alert {
  padding: 15px;
  margin-bottom: 15px;
  border-radius: 4px;
  display: none;
}

.alert.success {
  background: #d4edda;
  color: #155724;
  border: 1px solid #c3e6cb;
  display: block;
}

.alert.error {
  background: #f8d7da;
  color: #721c24;
  border: 1px solid #f5c6cb;
  display: block;
}

.stats {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 10px;
  margin-bottom: 20px;
}

.stat-card {
  background: white;
  padding: 15px;
  border-radius: 6px;
  box-shadow: 0 1px 4px rgba(0,0,0,0.1);
}

.stat-label {
  color: #999;
  font-size: 12px;
  margin-bottom: 5px;
}

.stat-value {
  font-size: 24px;
  font-weight: bold;
  color: #f53d2d;
}

.nav-links {
  margin-top: 20px;
  padding-top: 20px;
  border-top: 1px solid #ddd;
}

.nav-links a {
  display: block;
  padding: 10px;
  margin-bottom: 5px;
  background: white;
  text-decoration: none;
  color: #f53d2d;
  border-radius: 4px;
  text-align: center;
  font-weight: bold;
  transition: all 0.3s;
}

.nav-links a:hover {
  background: #f53d2d;
  color: white;
}
</style>
</head>
<body>

<header>
  <h1 data-i18n="seller.title">ğŸª å–å®¶ä¸­å¿ƒ</h1>
  <div class="user-info">
    <span id="userDisplay">æœªç™»å½•</span>
    <button onclick="logout()">é€€å‡ºç™»å½•</button>
  </div>
</header>

<div class="container">
  <div class="main-content">
    <!-- å·¦ä¾§è¾¹æ  - æ·»åŠ äº§å“è¡¨å• -->
    <div class="sidebar">
      <div class="stats">
        <div class="stat-card">
          <div class="stat-label">å•†å“æ€»æ•°</div>
          <div class="stat-value" id="totalProducts">0</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">æ€»é”€å”®é¢</div>
          <div class="stat-value" id="totalSales">RM 0</div>
        </div>
      </div>

      <div class="form-card">
        <h2 id="formTitle" data-i18n="seller.add">â• æ·»åŠ å•†å“</h2>
        
        <div id="alert" class="alert"></div>

        <div class="form-group">
          <label for="productName">å•†å“åç§° *</label>
          <input type="text" id="productName" placeholder="è¾“å…¥å•†å“åç§°" required>
        </div>

        <div class="form-group">
          <label for="productPrice">ä»·æ ¼ (RM) *</label>
          <input type="number" id="productPrice" placeholder="è¾“å…¥ä»·æ ¼" step="0.01" min="0" required>
        </div>

        <div class="form-group">
          <label for="productCategory">åˆ†ç±» *ï¼ˆå¯è‡ªå®šä¹‰ï¼‰</label>
          <input type="text" id="productCategory" placeholder="è¾“å…¥åˆ†ç±»åç§°ï¼Œä¾‹å¦‚ï¼šç”µå­äº§å“" required>
        </div>

        <div class="form-group">
          <label for="productDesc">å•†å“æè¿°</label>
          <textarea id="productDesc" placeholder="è¾“å…¥å•†å“æè¿°ï¼ˆå¯é€‰ï¼‰"></textarea>
        </div>

        <div class="form-group">
          <label for="productImage">å•†å“å›¾ç‰‡ï¼ˆå¯é€‰ï¼‰</label>
          <input type="file" id="productImage" accept="image/*">
          <div id="imagePreview" style="margin-top:8px"></div>
        </div>

        <div class="btn-group">
          <button class="btn btn-primary" onclick="addOrUpdateProduct()" id="submitBtn" data-i18n="seller.add">æ·»åŠ å•†å“</button>
          <button class="btn btn-secondary" onclick="cancelEdit()" id="cancelBtn" style="display:none;" data-i18n="seller.delete">å–æ¶ˆç¼–è¾‘</button>
        </div>
      </div>

      <div class="nav-links">
        <a href="index.html">ğŸ  è¿”å›é¦–é¡µ</a>
        <a href="orders.html">ğŸ“¦ æŸ¥çœ‹è®¢å•</a>
        <a href="seller_sales.html">ğŸ“ˆ é”€å”®è®°å½•</a>
      </div>
    </div>

    <!-- å³ä¾§ä¸»å†…å®¹ - å•†å“åˆ—è¡¨ -->
    <div class="content">
      <div class="products-card">
        <h2 data-i18n="seller.title">ğŸ“¦ æˆ‘çš„å•†å“</h2>
        <div style="margin-bottom:12px; text-align:right;">
          <!-- Bulk claim removed: single-item claim remains -->
        </div>
        <div id="productsList"></div>
        
        <hr style="margin:18px 0;" />

        <h2>ğŸ“ˆ é”€å”®è®°å½•</h2>
        <div style="margin-bottom:12px; text-align:right;">
          <button class="btn btn-secondary" onclick="loadSellerSales()">åˆ·æ–°é”€å”®è®°å½•</button>
          <button class="btn btn-secondary" onclick="loadSellerProductStats()">æŸ¥çœ‹å•†å“é”€å”®æ±‡æ€»</button>
        </div>
        <div id="salesArea">
          <p style="color:#999;">å°šæœªåŠ è½½é”€å”®è®°å½•ï¼Œç‚¹å‡»â€œåˆ·æ–°é”€å”®è®°å½•â€ä»¥æŸ¥çœ‹ã€‚</p>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
let currentUser = JSON.parse(localStorage.getItem("user")) || null;
let editingProductId = null;
let allProducts = [];

// æ£€æŸ¥ç”¨æˆ·ç™»å½•çŠ¶æ€
function checkLogin() {
  if (!currentUser) {
    alert('è¯·å…ˆç™»å½•å–å®¶è´¦å·');
    window.location.href = 'login.html';
    return false;
  }
  if (currentUser.role !== 'seller') {
    alert('æ­¤é¡µé¢ä»…é™å–å®¶è®¿é—®');
    window.location.href = 'index.html';
    return false;
  }
  return true;
}

// æ˜¾ç¤ºç”¨æˆ·ä¿¡æ¯
function showUser() {
  const userDiv = document.getElementById('userDisplay');
  if (currentUser) {
    userDiv.innerHTML = `æ¬¢è¿å›æ¥ï¼Œ<b>${currentUser.username}</b>`;
  }
}

// é€€å‡ºç™»å½•
function logout() {
  localStorage.removeItem("user");
  window.location.href = 'login.html';
}

// å®‰å…¨çš„ç½‘ç»œè¯·æ±‚
async function safeFetch(url, options) {
  try {
    const res = await fetch(url, options);
    const text = await res.text();
    
    try {
      return JSON.parse(text);
    } catch {
      console.error("è¿”å›éJSON:", text);
      return null;
    }
  } catch (err) {
    console.error("ç½‘ç»œè¯·æ±‚å¤±è´¥:", err.message);
    showAlert('ç½‘ç»œè¯·æ±‚å¤±è´¥: ' + err.message, 'error');
    return null;
  }
}

// æ˜¾ç¤ºæç¤ºä¿¡æ¯
function showAlert(message, type = 'success') {
  const alert = document.getElementById('alert');
  alert.textContent = message;
  alert.className = 'alert ' + type;
  if (type === 'success') {
    setTimeout(() => {
      alert.style.display = 'none';
    }, 3000);
  }
}

// åŠ è½½å–å®¶é”€å”®æ˜ç»†ï¼ˆç‹¬ç«‹å‡½æ•°ï¼Œä¾›æŒ‰é’®æˆ–å…¶å®ƒè§¦å‘ï¼‰
async function loadSellerSales(){
  if (!currentUser) return;
  const area = document.getElementById('salesArea');
  area.innerHTML = '<p>åŠ è½½ä¸­...</p>';
  const res = await safeFetch(`api.php?action=seller_sales&seller_id=${currentUser.id}`);
  if (!res) { area.innerHTML = '<p style="color:#999;">åŠ è½½å¤±è´¥</p>'; return; }
  if (!Array.isArray(res) || res.length === 0) {
    area.innerHTML = '<p style="color:#999;">æš‚æ— é”€å”®è®°å½•</p>';
    return;
  }
  // render list grouped by order_id
  const groups = {};
  res.forEach(r=>{
    const oid = r.order_id;
    if(!groups[oid]) groups[oid] = {order: r.order_id, date: r.order_date, buyer: r.buyer_username, payment_status: r.payment_status, payment_method: r.payment_method, items: []};
    groups[oid].items.push(r);
  });
  let html = '';
  Object.values(groups).forEach(g=>{
    html += `<div style="background:#fff;padding:12px;border-radius:6px;margin-bottom:10px;">
      <div style="font-weight:bold;color:#f53d2d">è®¢å• #${g.order} â€” ä¹°å®¶: ${escapeHtml(g.buyer||'æœªçŸ¥')} â€” ${g.date}</div>
      <div style="margin-top:8px">æ”¯ä»˜: ${escapeHtml(g.payment_method||'')} / ${escapeHtml(g.payment_status||'')}</div>
      <table style="width:100%;margin-top:8px;border-collapse:collapse"><tr style="background:#f3f3f3"><th>å•†å“</th><th>å•ä»·</th><th>æ•°é‡</th><th>å°è®¡</th></tr>`;
    g.items.forEach(it=>{
      const subtotal = (parseFloat(it.product_price) * parseInt(it.quantity)).toFixed(2);
      html += `<tr><td>${escapeHtml(it.product_name)}</td><td>RM ${parseFloat(it.product_price).toFixed(2)}</td><td>${it.quantity}</td><td>RM ${subtotal}</td></tr>`;
    });
    html += `</table></div>`;
  });
  area.innerHTML = html;
}

// åŠ è½½å–å®¶æ¯ä¸ªå•†å“çš„é”€å”®æ±‡æ€»ï¼ˆç‹¬ç«‹å‡½æ•°ï¼‰
async function loadSellerProductStats(){
  if (!currentUser) return;
  const area = document.getElementById('salesArea');
  area.innerHTML = '<p>åŠ è½½ä¸­...</p>';
  const res = await safeFetch(`api.php?action=seller_product_stats&seller_id=${currentUser.id}`);
  if (!res) { area.innerHTML = '<p style="color:#999;">åŠ è½½å¤±è´¥</p>'; return; }
  if (!Array.isArray(res) || res.length === 0) {
    area.innerHTML = '<p style="color:#999;">æš‚æ— é”€å”®ç»Ÿè®¡</p>';
    return;
  }
  let html = `<table><tr><th>å•†å“</th><th>å·²å”®æ•°é‡</th><th>æ€»æ”¶å…¥ (RM)</th></tr>`;
  res.forEach(r=>{
    html += `<tr><td>${escapeHtml(r.product_name)}</td><td>${r.total_sold}</td><td>RM ${parseFloat(r.total_revenue).toFixed(2)}</td></tr>`;
  });
  html += '</table>';
  area.innerHTML = html;
}

// è½¬ä¹‰HTML
function escapeHtml(str) {
  if (!str) return '';
  return String(str).replace(/[&<>"']/g, function(s) {
    return {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[s];
  });
}

// åŠ è½½å–å®¶çš„å•†å“åˆ—è¡¨
async function loadMyProducts() {
  if (!currentUser) return;
  
  const data = await safeFetch(`api.php?action=my_products&seller_id=${currentUser.id}`);
  if (!data) {
    document.getElementById('productsList').innerHTML = '<p style="text-align:center; color:#999;">åŠ è½½å¤±è´¥</p>';
    return;
  }

  allProducts = Array.isArray(data) ? data : [];
  
  const container = document.getElementById('productsList');
  
  if (allProducts.length === 0) {
    container.innerHTML = `
      <div class="empty-state">
        <div>ğŸ“­</div>
        <p>æš‚æ— å•†å“ï¼Œå»æ·»åŠ æ‚¨çš„ç¬¬ä¸€ä¸ªå•†å“å§ï¼</p>
      </div>
    `;
  } else {
    // ä½¿ç”¨ renderProductHTML ç”Ÿæˆæ¯ä¸ªæ¡ç›®ï¼Œä¾¿äºåç»­å±€éƒ¨æ›¿æ¢
    container.innerHTML = allProducts.map(p => renderProductHTML(p)).join('');
    if(window.__i18n && typeof window.__i18n.apply === 'function') window.__i18n.apply();
  }
  
  // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
  document.getElementById('totalProducts').textContent = allProducts.length;
}

// å¼€å§‹ç¼–è¾‘å•†å“
async function editProduct(productId) {
  const product = await safeFetch(`api.php?action=get_product&id=${productId}`);
  if (!product) return;
  
  editingProductId = productId;
  document.getElementById('productName').value = product.name || '';
  document.getElementById('productPrice').value = product.price || '';
  document.getElementById('productCategory').value = product.category_name || '';
  document.getElementById('productDesc').value = product.description || '';
  
  // æ›´æ”¹æŒ‰é’®çŠ¶æ€
  document.getElementById('formTitle').textContent = 'âœï¸ ç¼–è¾‘å•†å“';
  document.getElementById('submitBtn').textContent = 'ä¿å­˜ä¿®æ”¹';
  document.getElementById('cancelBtn').style.display = 'block';
  
  // æ»šåŠ¨åˆ°è¡¨å•
  document.querySelector('.form-card').scrollIntoView({ behavior: 'smooth' });
  // If product has an image, show preview placeholder
  const imgPreview = document.getElementById('imagePreview');
  const imgInput = document.getElementById('productImage');
  if (imgPreview) imgPreview.innerHTML = product.image ? `<img src="${product.image}" style="max-width:140px;max-height:90px;border-radius:6px;">` : '';
  if (imgInput) imgInput.value = '';
}

// å–æ¶ˆç¼–è¾‘
function cancelEdit() {
  editingProductId = null;
  document.getElementById('productName').value = '';
  document.getElementById('productPrice').value = '';
  document.getElementById('productCategory').value = '';
  document.getElementById('productDesc').value = '';
  const img = document.getElementById('productImage'); if(img) img.value = '';
  
  document.getElementById('formTitle').textContent = 'â• æ·»åŠ å•†å“';
  document.getElementById('submitBtn').textContent = 'æ·»åŠ å•†å“';
  document.getElementById('cancelBtn').style.display = 'none';
  
  document.getElementById('alert').style.display = 'none';
}

// æ·»åŠ æˆ–æ›´æ–°å•†å“
async function addOrUpdateProduct() {
  const name = document.getElementById('productName').value.trim();
  const price = parseFloat(document.getElementById('productPrice').value);
  const category = document.getElementById('productCategory').value.trim();
  const description = document.getElementById('productDesc').value.trim();

  if (!name || !price || !category) {
    showAlert('è¯·å¡«å†™å¿…å¡«é¡¹ï¼šå•†å“åç§°ã€ä»·æ ¼ã€åˆ†ç±»', 'error');
    return;
  }

  if (price <= 0) {
    showAlert('ä»·æ ¼å¿…é¡»å¤§äº0', 'error');
    return;
  }

  const action = editingProductId ? "update_product" : "add_product";
  const productData = {
    action,
    name,
    price,
    category, // send category name; backend will map to id
    seller_id: currentUser.id,
    description
  };

  // If an image file is selected, upload it first to get a path
  const fileInput = document.getElementById('productImage');
  if (fileInput && fileInput.files && fileInput.files[0]) {
    try {
      const fd = new FormData();
      fd.append('image', fileInput.files[0]);
      const upRes = await fetch('upload.php', { method: 'POST', body: fd });
      const upJson = await upRes.json();
      if (upJson && upJson.status === 'ok' && upJson.path) {
        productData.image = upJson.path;
      } else {
        showAlert((upJson && upJson.message) ? 'å›¾ç‰‡ä¸Šä¼ å¤±è´¥ï¼š' + upJson.message : 'å›¾ç‰‡ä¸Šä¼ å¤±è´¥', 'error');
        return;
      }
    } catch (e) {
      showAlert('å›¾ç‰‡ä¸Šä¼ å¤±è´¥ï¼š' + e.message, 'error');
      return;
    }
  }

  if (editingProductId) {
    productData.id = editingProductId;
  }
  const submitBtn = document.getElementById('submitBtn');
  const origText = submitBtn.innerHTML;
  submitBtn.disabled = true;
  submitBtn.innerHTML = editingProductId ? 'ä¿å­˜ä¸­...' : 'æ·»åŠ ä¸­...';

  const msg = await safeFetch("api.php", {
    method: "POST",
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify(productData)
  });

  submitBtn.disabled = false;
  submitBtn.innerHTML = origText;

  if (!msg) return;

  if (msg.status === "ok") {
    showAlert(editingProductId ? 'âœ“ å•†å“å·²æ›´æ–°' : 'âœ“ å•†å“å·²æ·»åŠ ', 'success');
    // è·å–æœ€æ–°å•†å“å¹¶å±€éƒ¨æ›¿æ¢/æ’å…¥
    const idToFetch = msg.product_id ? msg.product_id : (productData.id || editingProductId);
    if (idToFetch) {
      const prod = await safeFetch(`api.php?action=get_product&id=${idToFetch}`);
      if (prod && prod.id) replaceOrInsertProduct(prod);
    } else {
      await loadMyProducts();
    }
    cancelEdit();
  } else {
    showAlert(msg.message || 'æ“ä½œå¤±è´¥', 'error');
  }
}

// åˆ é™¤å•†å“
async function deleteProduct(productId) {
  if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªå•†å“å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ã€‚')) return;
  const btnId = `btn-delete-${productId}`;
  setButtonLoading(btnId, true, 'åˆ é™¤ä¸­...');
  const msg = await safeFetch("api.php", {
    method: "POST",
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify({ action: "delete_product", id: productId, seller_id: currentUser.id })
  });
  setButtonLoading(btnId, false);
  if (!msg) return;
  if (msg.status === "ok") {
    showAlert('âœ“ å•†å“å·²åˆ é™¤', 'success');
    const el = document.getElementById(`prod-${productId}`);
    if (el) el.remove();
    updateTotalCount();
    // åˆ·æ–°ç»Ÿè®¡
    loadSellerStats();
  } else {
    showAlert(msg.message || 'åˆ é™¤å¤±è´¥', 'error');
  }
}

// è®¤é¢†å•†å“ï¼ˆå°† seller_id è®¾ä¸ºå½“å‰å–å®¶ï¼‰
async function claimProduct(productId) {
  if (!confirm('ç¡®å®šè¦è®¤é¢†æ­¤å•†å“å¹¶å°†å…¶å½’å±ä¸ºæ‚¨çš„å•†å“å—ï¼Ÿ')) return;
  const btnId = `btn-claim-${productId}`;
  setButtonLoading(btnId, true, 'è®¤é¢†ä¸­...');
  const msg = await safeFetch("api.php", {
    method: "POST",
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify({ action: 'claim_product', id: productId, seller_id: currentUser.id })
  });
  setButtonLoading(btnId, false);
  if (!msg) return;
  if (msg.status === 'ok') {
    showAlert('âœ“ å•†å“å·²è®¤é¢†', 'success');
    const prod = await safeFetch(`api.php?action=get_product&id=${productId}`);
    if (prod && prod.id) replaceOrInsertProduct(prod);
  } else {
    showAlert(msg.message || 'è®¤é¢†å¤±è´¥', 'error');
  }
}

// å¼ºåˆ¶è®¤é¢†ï¼ˆè¦†ç›–åŸæœ‰ seller_idï¼Œæ“ä½œä¸å¯é€†ï¼Œéœ€è°¨æ…ï¼‰
async function forceClaimProduct(productId) {
  if (!confirm('å¼ºåˆ¶è®¤é¢†ä¼šæŠŠå•†å“çš„åŸæœ‰å½’å±è¦†ç›–ã€‚è¯·ç¡®è®¤æ‚¨æœ‰æƒé™å¹¶æ„¿æ„æ‰¿æ‹…åæœã€‚ç»§ç»­å—ï¼Ÿ')) return;
  const btnId = `btn-force-${productId}`;
  setButtonLoading(btnId, true, 'å¤„ç†ä¸­...');
  const msg = await safeFetch("api.php", {
    method: "POST",
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify({ action: 'force_claim_product', id: productId, seller_id: currentUser.id })
  });
  setButtonLoading(btnId, false);
  if (!msg) return;
  if (msg.status === 'ok') {
    // optional: show old/new owner info if returned by backend
    if (msg.old_owner) {
      showAlert(`âœ“ å·²å¼ºåˆ¶è®¤é¢†ï¼ˆåŸå½’å±: ${msg.old_owner} -> æ–°å½’å±: ${msg.new_owner || currentUser.id}ï¼‰`, 'success');
    } else {
      showAlert('âœ“ å·²å¼ºåˆ¶è®¤é¢†', 'success');
    }
    const prod = await safeFetch(`api.php?action=get_product&id=${productId}`);
    if (prod && prod.id) replaceOrInsertProduct(prod);
  } else {
    showAlert(msg.message || 'å¼ºåˆ¶è®¤é¢†å¤±è´¥', 'error');
  }
}

// Bulk claim removed by request. Use single-item 'è®¤é¢†å•†å“' (claimProduct) or 'å¼ºåˆ¶è®¤é¢†' for specific items.

// é¡µé¢åˆå§‹åŒ–
document.addEventListener('DOMContentLoaded', function() {
  if (!checkLogin()) return;
  showUser();
  // åŠ è½½å•†å“å¹¶åˆ·æ–°ç»Ÿè®¡ä¿¡æ¯
  loadMyProducts().then(() => {
    loadSellerStats();
  });
  // image input preview
  const imgInput = document.getElementById('productImage');
  if (imgInput) {
    imgInput.addEventListener('change', function(e){
      const p = document.getElementById('imagePreview');
      p.innerHTML = '';
      const f = this.files[0];
      if (!f) return;
      const url = URL.createObjectURL(f);
      p.innerHTML = `<img src="${url}" style="max-width:140px;max-height:90px;border-radius:6px;">`;
    });
  }
});

// åŠ è½½å–å®¶ç»Ÿè®¡ï¼ˆå•†å“æ€»æ•°ã€æ€»é”€å”®é¢ï¼‰
async function loadSellerStats(){
  if (!currentUser) return;
  const res = await safeFetch(`api.php?action=seller_stats&seller_id=${currentUser.id}`);
  if (!res) return;
  const total = parseInt(res.total_products) || 0;
  const sales = parseFloat(res.total_sales) || 0;
  document.getElementById('totalProducts').textContent = total;
  document.getElementById('totalSales').textContent = `RM ${sales.toFixed(2)}`;
}

// Helper: æ¸²æŸ“å•ä¸ªå•†å“ä¸º HTMLï¼ˆå¸¦å”¯ä¸€ idï¼Œä¾¿äºå±€éƒ¨æ›¿æ¢ï¼‰
function renderProductHTML(p) {
  const ownerNum = parseInt(p.seller_id) || 0;
  const me = parseInt(currentUser.id) || 0;
  let actions = '';
  if (ownerNum === me) {
    actions = `
      <button id="btn-edit-${p.id}" class="btn-edit" onclick="editProduct(${p.id})" data-i18n="seller.edit">âœï¸ ç¼–è¾‘</button>
      <button id="btn-delete-${p.id}" class="btn-delete" onclick="deleteProduct(${p.id})" data-i18n="seller.delete">ğŸ—‘ï¸ åˆ é™¤</button>
    `;
  } else if (ownerNum === 0) {
    actions = `<button id="btn-claim-${p.id}" class="btn-primary" onclick="claimProduct(${p.id})">ğŸ”– è®¤é¢†å•†å“</button>`;
  } else {
    // å•†å“å±äºå…¶ä»–å–å®¶ï¼šæ˜¾ç¤ºå½’å±å¹¶æä¾›å¼ºåˆ¶è®¤é¢†ï¼ˆè°¨æ…æ“ä½œï¼‰
    actions = `
      <span style="color:#999; font-size:13px; margin-right:8px;">å½’å±å–å®¶: ${ownerNum}</span>
      <button id="btn-force-${p.id}" class="btn-secondary" onclick="forceClaimProduct(${p.id})">âš ï¸ å¼ºåˆ¶è®¤é¢†</button>
    `;
  }

  // thumbnail HTML
  const imgHtml = p.image ? `<div style="margin-right:12px;"><img src="${escapeHtml(p.image)}" style="width:140px;height:90px;object-fit:cover;border-radius:6px;display:block"></div>` : '';

  return `
  <div class="product-item" id="prod-${p.id}">
    ${imgHtml}
    <div class="product-info">
      <h3>${escapeHtml(p.name)}</h3>
      <p>${escapeHtml(p.description || 'æš‚æ— æè¿°')}</p>
      <div class="product-price">RM ${parseFloat(p.price).toFixed(2)}</div>
      <div class="product-actions">
        ${actions}
      </div>
    </div>
  </div>
  `;
}

// Helper: ç”¨æ–°æ•°æ®æ›¿æ¢æˆ–æ’å…¥å•†å“å…ƒç´ 
function replaceOrInsertProduct(p) {
  const container = document.getElementById('productsList');
  const existing = document.getElementById(`prod-${p.id}`);
  const html = renderProductHTML(p);
  if (existing) {
    existing.outerHTML = html;
  } else {
    container.insertAdjacentHTML('afterbegin', html);
  }
  updateTotalCount();
  // åˆ·æ–°ç»Ÿè®¡ï¼ˆåŒ…æ‹¬æ€»é”€å”®é¢ï¼‰
  loadSellerStats();
  if(window.__i18n && typeof window.__i18n.apply === 'function') window.__i18n.apply();
}

// æ›´æ–°ç»Ÿè®¡æ•°å­—ï¼ˆåŸºäº DOM å…ƒç´ æ•°ï¼‰
function updateTotalCount() {
  const count = document.querySelectorAll('#productsList .product-item').length;
  document.getElementById('totalProducts').textContent = count;
}

// è®¾ç½®æŒ‰é’®åŠ è½½çŠ¶æ€
function setButtonLoading(btnId, loading, text) {
  const btn = document.getElementById(btnId);
  if (!btn) return;
  if (loading) {
    btn.disabled = true;
    btn.dataset.orig = btn.innerHTML;
    btn.innerHTML = text;
  } else {
    btn.disabled = false;
    if (btn.dataset.orig) btn.innerHTML = btn.dataset.orig;
  }
}
</script>

<script src="i18n.js"></script>

</body>
</html>
