<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>重置密码 — 输入验证码</title>
  <style>body{font-family:system-ui,Segoe UI,Roboto,Helvetica,Arial;margin:40px}label{display:block;margin:8px 0}input{padding:8px;width:320px}button{padding:8px 12px;margin-top:12px}#msg{margin-top:12px;color:green}#err{margin-top:8px;color:red}</style>
</head>
<body>
  <h1>使用验证码重置密码</h1>
  <p>请填写邮箱、收到的验证码和新的密码。</p>

  <label>邮箱
    <input id="username" type="email" placeholder="you@example.com">
  </label>
  <label>验证码
    <input id="code" type="text" placeholder="6 位验证码">
  </label>
  <label>新密码
    <input id="newpass" type="password" placeholder="新密码">
  </label>
  <label>确认新密码
    <input id="newpass2" type="password" placeholder="再次输入新密码">
  </label>

  <button id="resetBtn">重置密码</button>
  <div id="msg"></div>
  <div id="err"></div>

  <script>
    const resetBtn = document.getElementById('resetBtn');
    const msg = document.getElementById('msg');
    const err = document.getElementById('err');
    resetBtn.addEventListener('click', async () => {
      msg.textContent = ''; err.textContent = '';
      const username = document.getElementById('username').value.trim();
      const code = document.getElementById('code').value.trim();
      const p1 = document.getElementById('newpass').value;
      const p2 = document.getElementById('newpass2').value;
      if (!username || !code || !p1) { err.textContent = '请完整填写所有字段。'; return; }
      if (p1 !== p2) { err.textContent = '两次密码不一致。'; return; }

      resetBtn.disabled = true; msg.textContent = '正在提交...';
      try {
        const res = await fetch('auth.php', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ action: 'reset_password', username: username, code: code, new_password: p1 })
        });
        const j = await res.json();
        if (j.status === 'ok') {
          msg.textContent = '密码重置成功，请使用新密码登录。';
          err.textContent = '';
        } else {
          err.textContent = '失败：' + (j.message || '未知错误');
        }
      } catch (e) {
        err.textContent = '请求失败：' + e.message;
      }
      resetBtn.disabled = false;
    });
  </script>
</body>
</html>
<!DOCTYPE html>
<html lang="zh">
<head>
<meta charset="UTF-8">
<title>重置密码</title>
<style>
body { font-family: Arial; background: #f7f7f7; display:flex; justify-content:center; align-items:center; height:100vh; }
form { background:white; padding:30px; border-radius:10px; box-shadow:0 2px 10px rgba(0,0,0,0.1); }
input { display:block; width:300px; margin:10px 0; padding:8px; }
button { background:#f53d2d; color:white; border:none; padding:10px; width:100%; cursor:pointer; }
</style>
</head>
<body>

<form id="resetForm">
  <h2>设置新密码</h2>
  <input type="text" id="token" placeholder="重置码" required>
  <input type="password" id="password" placeholder="新密码" required>
  <input type="password" id="password2" placeholder="确认新密码" required>
  <button type="submit">重置密码</button>
  <div id="result" style="margin-top:12px;color:#333;"></div>
  <a href="login.html">返回登录</a>
</form>

<script>
// 从 query string 填充 token （若存在）
const params = new URLSearchParams(window.location.search);
if(params.has('token')){
  document.getElementById('token').value = params.get('token');
}

document.getElementById('resetForm').onsubmit = async function(e){
  e.preventDefault();
  const token = document.getElementById('token').value.trim();
  const pw = document.getElementById('password').value;
  const pw2 = document.getElementById('password2').value;
  if(!token) return alert('请输入重置码');
  if(!pw || pw !== pw2) return alert('两次密码输入不一致或为空');
  const payload = { action: 'reset_password', token, password: pw };
  try{
    const res = await fetch('auth.php', { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify(payload) });
    const msg = await res.json();
    if(msg.status === 'ok'){
      document.getElementById('result').textContent = '密码重置成功，请使用新密码登录';
    } else {
      document.getElementById('result').textContent = '错误：' + (msg.message || '重置失败');
    }
  } catch(err){
    document.getElementById('result').textContent = '网络错误：' + err.message;
  }
};
</script>

</body>
</html>
