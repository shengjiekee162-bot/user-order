<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>使用旧密码修改 - 更改密码</title>
  <style>
    body{font-family:system-ui,Segoe UI,Roboto,Helvetica,Arial;margin:28px;background:#fafafa}
    .card{max-width:480px;margin:0 auto;background:#fff;padding:22px;border-radius:8px;box-shadow:0 6px 20px rgba(0,0,0,0.08)}
    h1{font-size:20px;margin:0 0 12px}
    label{display:block;margin:10px 0}
    input{width:100%;padding:10px;border:1px solid #ddd;border-radius:6px}
    button{padding:10px 14px;border:none;background:#f53d2d;color:#fff;border-radius:6px;cursor:pointer}
    .muted{color:#666;font-size:0.9em}
    .small{padding:8px 10px}
  </style>
</head>
<body>
  <div class="card">
    <h1 data-i18n="change.title">使用旧密码修改密码</h1>
    <p class="muted">如果您记得旧密码，可以在此输入旧密码并设置新的密码（无需邮箱验证码）。</p>

    <label>用户名
      <input id="cp_username" type="text" placeholder="您的用户名" data-i18n="register.username" data-i18n-attr="placeholder">
    </label>

    <label>旧密码
      <input id="cp_old" type="password" placeholder="旧密码" data-i18n="login.password" data-i18n-attr="placeholder">
    </label>

    <label>新密码
      <input id="cp_new" type="password" placeholder="新密码">
    </label>

    <label>确认新密码
      <input id="cp_new2" type="password" placeholder="再次输入新密码">
    </label>

    <div style="display:flex;gap:8px;margin-top:6px">
      <button id="btn_change" data-i18n="change.submit">提交修改</button>
      <a href="login.html" style="align-self:center;margin-left:8px;color:#666;text-decoration:none">返回登录</a>
    </div>

    <div id="cp_msg" class="muted" style="margin-top:10px"></div>
  </div>

  <script>
    const el = id => document.getElementById(id);
    el('btn_change').addEventListener('click', async ()=>{
      const user = el('cp_username').value.trim();
      const oldp = el('cp_old').value;
      const p1 = el('cp_new').value; const p2 = el('cp_new2').value;
      const msg = el('cp_msg'); msg.textContent = ''; msg.style.color='';
      if(!user||!oldp||!p1){ msg.textContent = '请完整填写用户名、旧密码和新密码'; return; }
      if(p1 !== p2){ msg.style.color='red'; msg.textContent='两次新密码不一致'; return; }
      if(p1.length < 6){ msg.style.color='red'; msg.textContent='新密码至少 6 位'; return; }
      el('btn_change').disabled = true; msg.textContent = '提交中...';
      try{
        const res = await fetch('auth.php',{
          method:'POST', headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ action: 'change_password', username: user, old_password: oldp, new_password: p1 })
        });
        const j = await res.json();
        if(j.status === 'ok'){
          msg.style.color='green'; msg.textContent = '密码已更新，请使用新密码登录';
          setTimeout(()=> location.href='login.html', 1400);
        } else {
          msg.style.color='red'; msg.textContent = '修改失败：' + (j.message || '未知错误');
        }
      }catch(e){ msg.style.color='red'; msg.textContent = '请求失败：' + e.message; }
      el('btn_change').disabled = false;
    });
  </script>
</body>
</html>

<script src="i18n.js"></script>
